<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Modernozation Microservice Detailed Design Wizard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
  :root{
    --bg:#171213; --card:#23171a; --card-2:#2b1b1f; --border:#3c2227;
    --muted:#f7d9dd; --text:#fff7f8; --accent:#c21424; --accent-2:#e52a39; --accent-3:#ff9aa3;
    --btn:#b31a28; --btn-b:#ea3948; --btn-h:#c11f2f; --ink:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Inter",Segoe UI,Roboto,sans-serif;line-height:1.45}
  header{background:linear-gradient(90deg,#24171a,#2a171b);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;justify-content:space-between;flex-wrap:wrap;align-items:center}
  .title h1{font-size:1rem;margin:0;color:var(--text)}
  .title p{margin:2px 0 0;color:var(--muted);font-size:.8rem}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--btn);border:1px solid var(--btn-b);color:var(--ink);border-radius:.7rem;padding:.55rem .9rem;font-size:.9rem;cursor:pointer}
  .btn:hover{background:var(--btn-h)}
  .btn-sec{background:#2f1e21;border:1px solid var(--border);color:var(--ink);border-radius:.7rem;padding:.55rem .9rem;font-size:.9rem;cursor:pointer}
  .btn-sec:hover{background:#392126}
  .btn-mini{background:#2f1e21;border:1px solid var(--border);border-radius:.6rem;padding:.35rem .6rem;font-size:.8rem;color:var(--ink);cursor:pointer}
  .btn-mini:hover{background:#392126}
  .btn-danger{background:#7a1823;border-color:#a11f2d}
  .btn-danger:hover{background:#8b1b28}
  .nav-steps{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:12px 20px;border-bottom:1px solid var(--border);background:#1f1518}
  .step-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:.7rem;background:#2f1d21;cursor:pointer;user-select:none}
  .step-pill.active{border-color:var(--accent-2);box-shadow:0 0 0 1px var(--accent-2) inset}
  .step-index{background:#3a2327;color:#ffe1e4;border:1px solid var(--border);width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;font-size:.78rem}
  main{max-width:1200px;margin:0 auto;padding:22px;display:grid;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:18px;box-shadow:0 20px 40px rgba(0,0,0,.45)}
  .card h2{margin:.2rem 0 .6rem;font-size:1rem}
  .hint{color:var(--accent-3);font-size:.8rem;margin:-.25rem 0 .6rem}
  .block{background:var(--card-2);border:1px solid var(--border);border-radius:.75rem;padding:14px;margin:.6rem 0}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  .label{font-size:.82rem;font-weight:600;margin-bottom:.25rem}
  .expl{color:var(--muted);font-size:.75rem}
  input[type=text],input[type=date],select,textarea{width:100%;background:#3a2428;border:1px solid var(--border);color:#fff;border-radius:.6rem;padding:.6rem .7rem;font-size:.9rem}
  textarea{min-height:90px;resize:vertical}.tall{min-height:140px}
  table{width:100%;border-collapse:collapse;color:#ffeff1;font-size:.86rem}
  th,td{border:1px solid var(--border);padding:.5rem .6rem;vertical-align:top}
  th{background:#342125;text-align:left}
  .inline-hint{font-size:.74rem;color:#ffd6d9;margin-top:.25rem}
  .muted{color:var(--muted)}
  .controls{display:flex;justify-content:space-between;gap:8px;margin-top:6px}
  .hidden{display:none}
  .toast{position:fixed;right:16px;bottom:16px;background:#3a2327;border:1px solid var(--btn-b);color:#fff;padding:.7rem .9rem;border-radius:.7rem;display:none;z-index:10}
</style>
</head>
<body>
<header>
  <div class="title">
    <h1>Modernozation Microservice Detailed Design Wizard</h1>
    <p>Steps 1–2 • Save/Load/Export JSON • Lighter red theme</p>
  </div>
  <div class="actions">
    <button class="btn-sec" id="btnLoad">Load JSON</button>
    <button class="btn" id="btnExportJson">Export JSON</button>
    <button class="btn" id="export-md">Export Markdown</button>
    <button class="btn" id="export-doc">Export full .doc</button>
    <button class="btn-sec" id="btnMock">Load Mock Data</button>
    <button class="btn-sec" id="btnClear">Clear Form</button>
  </div>
</header>

<div class="nav-steps" id="nav"></div>
<main><section class="card"><div id="stepMount"></div></section></main>
<div id="toast" class="toast"></div>

<!-- ======================================================
     STEP PACKS (templates + registration)
====================================================== -->

<!-- === STEP 1: Service Overview (with Boundaries & Responsibilities) === -->
<template id="tpl-step-1">
  <h2>Step 1 — Service Overview</h2>
  <p class="hint">Name • Status • Date • Owners • Business context • Service purpose • Boundaries & responsibilities</p>

  <div class="card">
    <h2>1.0 Core Details</h2>
    <div class="block row-3">
      <div><div class="label">Service name</div><input data-k="svcName" type="text" placeholder="e.g., customer-claim"/></div>
      <div><div class="label">Service key / code</div><input data-k="svcKey" type="text" placeholder="e.g., cust-claim-svc"/></div>
      <div><div class="label">Version</div><input data-k="svcVer" type="text" placeholder="e.g., 1.0.0"/></div>
    </div>
    <div class="block row-3">
      <div><div class="label">Status</div>
        <select data-k="svcStatus"><option>Draft</option><option>For review</option></select>
        <div class="expl">Only these two are valid.</div>
      </div>
      <div><div class="label">Date</div><input data-k="svcDate" type="date"/><div class="expl">Defaults to today.</div></div>
      <div><div class="label">Domain / Area</div><input data-k="svcDomain" type="text" placeholder="e.g., Claims"/></div>
    </div>
    <div class="block row-2">
      <div><div class="label">Service owner</div><input data-k="svcOwner" type="text" placeholder="Name / Role"/></div>
      <div><div class="label">Technical lead</div><input data-k="svcTL" type="text" placeholder="Name / Role"/></div>
    </div>
  </div>

  <div class="card">
    <h2>1.1 Business Context & Service Purpose</h2>
    <div class="block">
      <div class="label">Business context</div>
      <textarea data-k="businessContext" class="tall">Describe the business problem this service solves and its role in the overall system</textarea>
    </div>
    <div class="block">
      <div class="label">Service purpose</div>
      <textarea data-k="servicePurpose" class="tall" placeholder="What this service is responsible for (capabilities, boundaries, non-goals)"></textarea>
    </div>
  </div>

  <div class="card">
    <h2>1.2 Service Boundaries & Responsibilities</h2>
    <div class="block">
      <div class="label">Primary responsibilities</div>
      <table id="respTable">
        <thead><tr><th>Responsibility</th><th>Notes (optional)</th><th style="width:40px"></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn-mini" id="btnAddResp">+ Add responsibility</button>
      <div class="inline-hint">Examples: “Validate claim inputs”, “Calculate eligibility”, “Persist claim state”, “Publish claim-updated event”.</div>
    </div>
    <div class="block">
      <div class="label">Non-goals / out of scope</div>
      <table id="ngoalTable">
        <thead><tr><th>Non-goal (what this service does NOT do)</th><th style="width:40px"></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn-mini" id="btnAddNGoal">+ Add non-goal</button>
    </div>
    <div class="block">
      <div class="label">External boundaries / handoffs</div>
      <textarea data-k="externalBoundaries" class="tall" placeholder="Interfaces and responsibilities that belong to other services/teams; where handoffs occur."></textarea>
    </div>
  </div>

  <div class="card">
    <h2>1.3 Use Cases (high-level)</h2>
    <div class="block">
      <table id="useCasesTable">
        <thead><tr><th>Use case name</th><th>Primary actor</th><th>Outcome / value</th><th style="width:40px"></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn-mini" id="btnAddUseCase">+ Add use case</button>
      <div class="expl" style="margin-top:.5rem">Keep it brief (1–2 lines per row).</div>
    </div>
  </div>

  <div class="controls">
    <div></div>
    <button type="button" class="btn" data-next>Next → API</button>
  </div>
</template>

<!-- === STEP 2: API Specifications (REST) === -->
<template id="tpl-step-2">
  <h2>Step 2 — API Specifications (REST)</h2>
  <p class="hint">Swagger (in/out) • Endpoints • Idempotency • Error mapping (per endpoint)</p>

  <div class="card">
    <h2>2.0 Protocol & API Artifacts</h2>
    <div class="block">
      <div class="label">Protocol</div>
      <div class="expl">REST is the default protocol for all service-to-service and client-to-service communication.</div>
    </div>
    <div class="block row-2">
      <div>
        <div class="label">Swagger — Input (Requests)</div>
        <input type="file" accept=".json,.yaml,.yml" data-k="swaggerInFile"/>
        <div class="expl">We store the file name in JSON (not the file bytes).</div>
      </div>
      <div>
        <div class="label">Swagger — Output (Responses)</div>
        <input type="file" accept=".json,.yaml,.yml" data-k="swaggerOutFile"/>
        <div class="expl">We store the file name in JSON (not the file bytes).</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>2.1 Endpoints</h2>
    <div class="block">
      <table id="epTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="width:22%">Path</th>
            <th style="width:10%">Method</th>
            <th style="width:10%">Idempotent</th>
            <th>Idempotency Config (shown only when relevant)</th>
            <th>Error Mapping (per endpoint)</th>
            <th style="width:40px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn-mini" id="btnAddEndpoint">+ Add endpoint</button>
      <div class="expl" style="margin-top:.5rem">
        Defaults: GET/PUT/DELETE → Idempotent = Yes. POST → Idempotent = No.  
        “Error Mapping” = per-endpoint list of HTTP codes (400–503) with short meanings.
      </div>
    </div>
  </div>

  <div class="controls">
    <button type="button" class="btn-sec" data-prev>← Back</button>
    <button type="button" class="btn" data-next>Next → Message Broker</button>
  </div>
</template>
<!-- === STEP 3: Message Broker Integration === -->
<template id="tpl-step-3">
    <h2>Step 3 — Message Broker Integration</h2>
    <p class="hint">Rationale • Technology choice (RabbitMQ / Kafka) • Published & Consumed events • Payload schema uploads</p>
  
    <!-- 4.1 Rationale + Technology Choice (visual side-by-side) -->
    <div class="card">
      <h2>3.1 Rationale & Technology Choice</h2>
      <div class="block" style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px">
        <!-- Rationale checkboxes -->
        <div>
          <div class="label">Rationale for using messaging</div>
          <div class="inline-hint">Select all that apply.</div>
          <div class="block">
            <label><input type="checkbox" class="mb-rat" value="decouple"/> Decoupling producers/consumers (reduced coupling)</label><br/>
            <label><input type="checkbox" class="mb-rat" value="async"/> Asynchronous processing / smoothing traffic</label><br/>
            <label><input type="checkbox" class="mb-rat" value="buffering"/> Buffering / back-pressure handling</label><br/>
            <label><input type="checkbox" class="mb-rat" value="replay"/> Event replay / auditability (Kafka)</label><br/>
            <label><input type="checkbox" class="mb-rat" value="reliability"/> Higher reliability (acks, retries, DLQs)</label><br/>
            <label><input type="checkbox" class="mb-rat" value="fanout"/> Fan-out / multi-consumer delivery</label><br/>
            <label><input type="checkbox" class="mb-rat" value="cross"/> Cross-boundary integration with external systems</label>
          </div>
        </div>
        <!-- Technology choice (explanation placed visually next to the checkboxes) -->
        <div>
          <div class="label">Technology choice (guidance)</div>
          <div class="block">
            <div class="expl"><b>Internal Communication (within Kubernetes): RabbitMQ</b><br/>
            Used for: Inter-service asynchronous communication within the cluster<br/>
            Rationale: Lightweight, low latency, simpler for internal events.</div>
          </div>
          <div class="block" style="margin-top:10px">
            <div class="expl"><b>External Communication (outside Kubernetes): Kafka</b><br/>
            Used for: Events from/to external systems, cross-boundary messaging<br/>
            Rationale: Durable, event replay.</div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- 4.2 Published Events -->
    <div class="card">
      <h2>3.2 Published Events</h2>
      <div id="pubWrap"></div>
      <button class="btn-mini" id="btnAddPub">+ Add published event</button>
      <div class="expl" style="margin-top:.5rem">Upload payload schema (JSON/Avro/YAML). We store the file name in JSON, not the file bytes.</div>
    </div>
  
    <!-- 4.3 Consumed Events -->
    <div class="card">
      <h2>3.3 Consumed Events</h2>
      <div id="conWrap"></div>
      <button class="btn-mini" id="btnAddCon">+ Add consumed event</button>
    </div>
  
    <div class="controls">
        <button type="button" class="btn-sec" data-prev>← Back</button>
        <button type="button" class="btn" data-next>Next</button>
      </div>
  </template>
  <!-- === STEP 5: Caching Layer === -->
<template id="tpl-step-5">
    <h2>Step 5 — Caching Layer</h2>
    <p class="hint">Choose Redis or Memcached • Topology • Key/TTL strategy • Invalidation • Persistence • Security • Ops</p>
  
    <div class="card">
      <h2>5.1 Cache Solution</h2>
      <div class="block row-2">
        <div>
          <div class="label">Engine</div>
          <select id="cl-engine">
            <option>Redis</option>
            <option>Memcached</option>
          </select>
          <div class="inline-hint">Redis = richer features (TTL, eviction policies, clustering, persistence). Memcached = simple, fast, in-memory only.</div>
        </div>
        <div>
          <div class="label">Intended usage</div>
          <select id="cl-usage">
            <option>Request caching (API responses)</option>
            <option>Hot object caching (entities)</option>
            <option>Computation caching</option>
            <option>Session/token caching</option>
            <option>Other</option>
          </select>
          <input id="cl-usage-custom" class="hidden" type="text" placeholder="Describe usage" />
        </div>
      </div>
    </div>
  
    <div class="card">
      <h2>5.2 Topology & Sizing</h2>
      <div class="block">
        <div class="row-3">
          <div>
            <div class="label">Deployment / topology</div>
            <select id="cl-topology">
              <option>Standalone</option>
              <option>Primary/Replica</option>
              <option>Clustered / Sharded</option>
              <option>Managed service</option>
            </select>
            <div class="inline-hint">Choose based on availability & scale. Clustered/sharded for large datasets.</div>
          </div>
          <div>
            <div class="label">Estimated data size</div>
            <input id="cl-size" type="text" placeholder="e.g., 5–10 GB"/>
            <div class="inline-hint">Peak cache footprint incl. overhead.</div>
          </div>
          <div>
            <div class="label">Throughput / QPS</div>
            <input id="cl-qps" type="text" placeholder="e.g., 3k req/s peak"/>
            <div class="inline-hint">Guides connection pooling & node count.</div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="card">
      <h2>5.3 Keys, TTLs & Eviction</h2>
      <div class="block">
        <div class="row-2">
          <div>
            <div class="label">Key namespace / pattern</div>
            <input id="cl-keyns" type="text" placeholder="e.g., svc:claims:v1:{claimId}"/>
            <div class="inline-hint">Prefix with service + version to avoid collisions.</div>
          </div>
          <div>
            <div class="label">Serialization</div>
            <select id="cl-ser">
              <option>JSON</option>
              <option>MsgPack</option>
              <option>Protocol Buffers</option>
              <option>String</option>
            </select>
            <div class="inline-hint">Pick compact formats for large volumes.</div>
          </div>
        </div>
  
        <div class="row-3" style="margin-top:10px">
          <div>
            <div class="label">Default TTL</div>
            <input id="cl-ttl" type="text" placeholder="e.g., 10m"/>
            <div class="inline-hint">Set a sane default; override per key as needed.</div>
          </div>
          <div>
            <div class="label">Per-key TTL overrides</div>
            <textarea id="cl-ttl-over" class="tall" placeholder="e.g., svc:claims:v1:list:* → 60s&#10;svc:claims:v1:item:* → 10m"></textarea>
            <div class="inline-hint">One rule per line: pattern → TTL.</div>
          </div>
          <div>
            <div class="label">Compression</div>
            <select id="cl-compress">
              <option>None</option>
              <option>Auto (size > N KB)</option>
              <option>Always compress</option>
            </select>
            <div class="inline-hint">Compression trades CPU for memory/bandwidth.</div>
          </div>
        </div>
  
        <div id="cl-evict-redis" class="row-2" style="margin-top:10px">
          <div>
            <div class="label">Eviction policy (Redis)</div>
            <select id="cl-evict">
              <option>volatile-lru</option>
              <option>volatile-ttl</option>
              <option>volatile-random</option>
              <option>allkeys-lru</option>
              <option>allkeys-lfu</option>
              <option>noeviction</option>
            </select>
            <div class="inline-hint">Use allkeys-* when most keys lack TTL; volatile-* when most have TTL.</div>
          </div>
          <div>
            <div class="label">Maxmemory / headroom</div>
            <input id="cl-maxmem" type="text" placeholder="e.g., 8 GB with 20% headroom"/>
            <div class="inline-hint">Set memory cap and keep headroom to prevent thrash.</div>
          </div>
        </div>
  
        <div id="cl-evict-memc" class="row-2 hidden" style="margin-top:10px">
          <div>
            <div class="label">Eviction (Memcached)</div>
            <input id="cl-evict-m" type="text" placeholder="LRU (built-in)"/>
            <div class="inline-hint">Memcached uses slab allocator + LRU by default.</div>
          </div>
          <div>
            <div class="label">Memory allocation</div>
            <input id="cl-memc-mem" type="text" placeholder="e.g., 16 GB total"/>
            <div class="inline-hint">Split across nodes for horizontal scale.</div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="card">
      <h2>5.4 Invalidation Strategy</h2>
      <div class="block row-2">
        <div>
          <div class="label">Pattern</div>
          <select id="cl-inv">
            <option>Cache-aside (lazy)</option>
            <option>Write-through</option>
            <option>Write-behind (async)</option>
            <option>Pub/Sub fanout (event-based)</option>
            <option>Custom</option>
          </select>
          <input id="cl-inv-custom" class="hidden" type="text" placeholder="Describe custom invalidation" />
          <div class="inline-hint">Choose based on freshness, write rate, and failure modes.</div>
        </div>
        <div>
          <div class="label">Warm-up / Preload</div>
          <input id="cl-warm" type="text" placeholder="e.g., preload top N frequently accessed keys on deploy"/>
          <div class="inline-hint">Prevents cold-start latency spikes.</div>
        </div>
      </div>
    </div>
  
    <div class="card" id="cl-redis-only">
      <h2>5.5 Redis Persistence & Reliability</h2>
      <div class="block row-3">
        <div>
          <div class="label">Persistence mode</div>
          <select id="cl-persist">
            <option>None (pure cache)</option>
            <option>AOF (append-only)</option>
            <option>RDB snapshots</option>
            <option>AOF + RDB</option>
          </select>
          <div class="inline-hint">For pure caching, persistence is usually disabled.</div>
        </div>
        <div>
          <div class="label">Replication</div>
          <select id="cl-rep">
            <option>Disabled</option>
            <option>Enabled (replica(s))</option>
          </select>
          <div class="inline-hint">Adds HA; consider failover times & consistency.</div>
        </div>
        <div>
          <div class="label">Cluster slot / hash tags</div>
          <input id="cl-hashtag" type="text" placeholder="e.g., svc:{userId}:* for key affinity"/>
          <div class="inline-hint">Hash tags keep related keys in same shard.</div>
        </div>
      </div>
    </div>
  
    <div class="card">
      <h2>5.6 Security & Ops</h2>
      <div class="block row-3">
        <div>
          <div class="label">Auth</div>
          <select id="cl-auth">
            <option>Password/ACL</option>
            <option>mTLS (sidecar/ingress)</option>
            <option>Network policy only</option>
            <option>Custom</option>
          </select>
          <input id="cl-auth-custom" class="hidden" type="text" placeholder="Auth details if custom"/>
        </div>
        <div>
          <div class="label">TLS</div>
          <select id="cl-tls">
            <option>Disabled (internal only)</option>
            <option>TLS 1.2+</option>
            <option>TLS 1.3</option>
          </select>
          <div class="inline-hint">Enable in multi-tenant or cross-zone traffic.</div>
        </div>
        <div>
          <div class="label">Monitoring / metrics</div>
          <input id="cl-metrics" type="text" placeholder="e.g., cpu, mem, evictions, hits/misses, latency, conn"/>
          <div class="inline-hint">Hook to your Observability stack.</div>
        </div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 6: Security (AuthN, AuthZ, Security Audit, Data Protection) === -->
<template id="tpl-step-6">
    <h2>Step 6 — Security</h2>
    <p class="hint">Authentication • Authorization • Security audit • Data protection</p>
  
    <!-- 6.1 Authentication -->
    <div class="card">
      <h2>6.1 Authentication</h2>
      <div class="block row-3">
        <div>
          <div class="label">Method</div>
          <select id="sec-auth-method">
            <option>OAuth 2.0 (Client Credentials)</option>
            <option>OAuth 2.0 (Auth Code)</option>
            <option>JWT (first-party)</option>
            <option>mTLS</option>
            <option>API Key</option>
            <option>Other</option>
          </select>
          <input id="sec-auth-method-custom" class="hidden" type="text" placeholder="Describe custom/other method"/>
        </div>
        <div>
          <div class="label">Token Validation</div>
          <select id="sec-auth-validate">
            <option>Introspection endpoint</option>
            <option>JWKS (signature verify)</option>
            <option>mTLS cert verify</option>
            <option>Other</option>
          </select>
          <input id="sec-auth-validate-custom" class="hidden" type="text" placeholder="Describe custom validation"/>
        </div>
        <div>
          <div class="label">Token Expiration</div>
          <input id="sec-auth-exp" type="text" placeholder="e.g., 1h"/>
          <div class="inline-hint">Access token TTL; refresh handled by client if applicable.</div>
        </div>
      </div>
      <div class="block">
        <div class="label">Required Scopes</div>
        <table id="sec-auth-scopes" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Scope</th><th>Description (optional)</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="sec-add-scope">+ Add scope</button>
      </div>
    </div>
  
    <!-- 6.2 Authorization -->
    <div class="card">
      <h2>6.2 Authorization</h2>
      <div class="block row-3">
        <div>
          <div class="label">Model</div>
          <select id="sec-authz-model">
            <option>RBAC</option>
            <option>ABAC</option>
            <option>ReBAC</option>
            <option>Custom</option>
          </select>
          <input id="sec-authz-model-custom" class="hidden" type="text" placeholder="Describe custom model"/>
        </div>
        <div>
          <div class="label">Policy Engine</div>
          <select id="sec-authz-engine">
            <option>OPA (Rego)</option>
            <option>Cedar</option>
            <option>Service code (inline)</option>
            <option>Other</option>
          </select>
          <input id="sec-authz-engine-custom" class="hidden" type="text" placeholder="Describe custom engine"/>
        </div>
        <div>
          <div class="label">Enforcement Point</div>
          <select id="sec-authz-enforce">
            <option>API Gateway</option>
            <option>Service middleware</option>
            <option>Sidecar (Envoy/Istio)</option>
            <option>Custom</option>
          </select>
          <input id="sec-authz-enforce-custom" class="hidden" type="text" placeholder="Describe custom enforcement point"/>
        </div>
      </div>
      <div class="block">
        <div class="label">Permissions / Roles matrix</div>
        <table id="sec-authz-matrix" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Role</th><th>Resource</th><th>Action</th><th>Condition (optional)</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="sec-add-perm">+ Add permission</button>
        <div class="inline-hint">Examples: role=ClaimsAgent • resource=claim • action=update • condition=ownsPolicy==true</div>
      </div>
    </div>
  
    <!-- 6.3 Security Audit -->
    <div class="card">
      <h2>6.3 Security Audit</h2>
      <div class="block row-3">
        <div>
          <div class="label">Audit scope</div>
          <select id="sec-audit-scope">
            <option>Authentication events</option>
            <option>Authorization decisions</option>
            <option>Data access (PII)</option>
            <option>Admin/config changes</option>
            <option>All of the above</option>
          </select>
        </div>
        <div>
          <div class="label">Retention</div>
          <input id="sec-audit-ret" type="text" placeholder="e.g., 1y (per compliance)"/>
        </div>
        <div>
          <div class="label">Destination</div>
          <select id="sec-audit-dst">
            <option>SIEM</option>
            <option>Central log pipeline</option>
            <option>External audit store</option>
            <option>Other</option>
          </select>
          <input id="sec-audit-dst-custom" class="hidden" type="text" placeholder="Describe custom destination"/>
        </div>
      </div>
      <div class="block">
        <div class="label">Event details (what to record)</div>
        <textarea id="sec-audit-fields" class="tall" placeholder="e.g., subject, scopes/roles, decision, resource, correlationId, clientId, sanitized identifiers"></textarea>
      </div>
    </div>
  
    <!-- 6.4 Data Protection -->
    <div class="card">
      <h2>6.4 Data Protection</h2>
      <div class="block">
        <div class="label">PII / Sensitive Data Handling</div>
        <table id="sec-pii" style="width:100%;border-collapse:collapse">
          <thead><tr><th>PII / Sensitive field</th><th>Who can access</th><th>How access is restricted</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="sec-add-pii">+ Add row</button>
      </div>
      <div class="block">
        <div class="label">Data Masking / Redaction Strategy</div>
        <table id="sec-mask" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Data field</th><th>Masking / Redaction</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="sec-add-mask">+ Add rule</button>
        <div class="inline-hint">Masking options: full, last4, hash, redact, tokenize, custom.</div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 7: Observability === -->
<template id="tpl-step-7">
    <h2>Step 7 — Observability</h2>
    <p class="hint">Logging (per environment) • Metrics/SLOs • Traces • Dashboards • Alerts • Key log events</p>
  
    <!-- 7.1 Logging -->
    <div class="card">
      <h2>7.1 Logging</h2>
      <div class="block row-3">
        <div>
          <div class="label">Production log level</div>
          <select id="ob-log-prod">
            <option>ERROR</option><option>WARN</option><option>INFO</option><option>DEBUG</option><option>TRACE</option>
          </select>
        </div>
        <div>
          <div class="label">Staging log level</div>
          <select id="ob-log-stg">
            <option>ERROR</option><option>WARN</option><option>INFO</option><option>DEBUG</option><option>TRACE</option>
          </select>
        </div>
        <div>
          <div class="label">Development log level</div>
          <select id="ob-log-dev">
            <option>ERROR</option><option>WARN</option><option>INFO</option><option>DEBUG</option><option>TRACE</option>
          </select>
        </div>
      </div>
      <div class="block">
        <div class="label">Log sink / pipeline</div>
        <select id="ob-log-sink">
          <option>Central log pipeline</option>
          <option>SIEM</option>
          <option>Cloud logging</option>
          <option>Other</option>
        </select>
        <input id="ob-log-sink-custom" class="hidden" type="text" placeholder="Describe custom sink"/>
      </div>
    </div>
  
    <!-- 7.2 Metrics & SLOs -->
    <div class="card">
      <h2>7.2 Metrics & SLOs</h2>
      <div class="block">
        <div class="label">Primary metrics (add rows)</div>
        <table id="ob-metrics" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Metric</th><th>Type</th><th>SLO / Target</th><th>Collection (agent/lib)</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ob-add-metric">+ Add metric</button>
        <div class="inline-hint">Examples: p95 latency &lt; 300ms; error rate &lt; 0.5%; CPU &lt; 70%.</div>
      </div>
    </div>
  
    <!-- 7.3 Distributed Tracing -->
    <div class="card">
      <h2>7.3 Distributed Tracing</h2>
      <div class="block row-3">
        <div>
          <div class="label">Tracing</div>
          <select id="ob-tracing">
            <option>Disabled</option>
            <option>OpenTelemetry (OTLP)</option>
            <option>Jaeger</option>
            <option>Zipkin</option>
            <option>Other</option>
          </select>
          <input id="ob-tracing-custom" class="hidden" type="text" placeholder="Describe custom tracer"/>
        </div>
        <div>
          <div class="label">Sampling rate</div>
          <input id="ob-sampling" type="text" placeholder="e.g., 10%"/>
          <div class="inline-hint">Use lower in production, higher in staging/dev.</div>
        </div>
        <div>
          <div class="label">Propagation</div>
          <select id="ob-prop">
            <option>W3C traceparent</option>
            <option>b3</option>
            <option>both</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- 7.4 Dashboards -->
    <div class="card">
      <h2>7.4 Dashboards</h2>
      <div class="block">
        <table id="ob-dash" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Name</th><th>System (e.g., Grafana, DataDog)</th><th>Link/ID</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ob-add-dash">+ Add dashboard</button>
      </div>
    </div>
  
    <!-- 7.5 Alerts -->
    <div class="card">
      <h2>7.5 Alerts</h2>
      <div class="block">
        <table id="ob-alerts" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Severity</th><th>Condition / Threshold</th><th>Channel</th><th>Runbook / Notes</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ob-add-alert">+ Add alert</button>
        <div class="inline-hint">Channel examples: Slack, Email, PagerDuty/Opsgenie.</div>
      </div>
    </div>
  
    <!-- 7.6 Key Log Events -->
    <div class="card">
      <h2>7.6 Key Log Events</h2>
      <div class="block">
        <table id="ob-logs" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Event type</th><th>What we log</th><th>Level</th><th>PII safe?</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ob-add-log">+ Add event</button>
        <div class="inline-hint">Examples for “What we log”: for API request/response → duration, status code, sanitized.</div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 8: Performance & Scalability === -->
<template id="tpl-step-8">
    <h2>Step 8 — Performance &amp; Scalability</h2>
    <p class="hint">Targets per environment • Resource profile • Autoscaling • Concurrency & pools • Rate limiting • Backpressure/overload</p>
  
    <!-- 8.1 Targets per environment -->
    <div class="card">
      <h2>8.1 Targets per environment</h2>
      <div class="block">
        <table id="ps-env" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Environment</th>
              <th>Throughput (RPS)</th>
              <th>p95 latency (ms)</th>
              <th>p99 latency (ms)</th>
              <th>Error rate (max %)</th>
              <th>Availability (SLO %)</th>
            </tr>
          </thead>
          <tbody>
            <tr data-env="prod">
              <td><b>Production</b></td>
              <td><input type="text" class="ps-prod-rps" placeholder="e.g., 1500"/></td>
              <td><input type="text" class="ps-prod-p95" placeholder="e.g., 300"/></td>
              <td><input type="text" class="ps-prod-p99" placeholder="e.g., 800"/></td>
              <td><input type="text" class="ps-prod-err" placeholder="e.g., 0.5"/></td>
              <td><input type="text" class="ps-prod-slo" placeholder="e.g., 99.9"/></td>
            </tr>
            <tr data-env="staging">
              <td><b>Staging</b></td>
              <td><input type="text" class="ps-stg-rps" placeholder="e.g., 300"/></td>
              <td><input type="text" class="ps-stg-p95" placeholder="e.g., 400"/></td>
              <td><input type="text" class="ps-stg-p99" placeholder="e.g., 900"/></td>
              <td><input type="text" class="ps-stg-err" placeholder="e.g., 1.0"/></td>
              <td><input type="text" class="ps-stg-slo" placeholder="e.g., 99.5"/></td>
            </tr>
            <tr data-env="dev">
              <td><b>Development</b></td>
              <td><input type="text" class="ps-dev-rps" placeholder="e.g., 50"/></td>
              <td><input type="text" class="ps-dev-p95" placeholder="e.g., 500"/></td>
              <td><input type="text" class="ps-dev-p99" placeholder="e.g., 1200"/></td>
              <td><input type="text" class="ps-dev-err" placeholder="e.g., 2.0"/></td>
              <td><input type="text" class="ps-dev-slo" placeholder="e.g., 99.0"/></td>
            </tr>
          </tbody>
        </table>
        <div class="inline-hint">RPS = requests per second. Set realistic targets per env.</div>
      </div>
    </div>
  
    <!-- 8.2 Resource profile (per pod/container) -->
    <div class="card">
      <h2>8.2 Resource profile (per pod/container)</h2>
      <div class="block row-3">
        <div>
          <div class="label">CPU requests / limits</div>
          <input id="ps-cpu" type="text" placeholder="e.g., 300m / 1000m"/>
          <div class="inline-hint">Requests schedule capacity; limits cap bursts.</div>
        </div>
        <div>
          <div class="label">Memory requests / limits</div>
          <input id="ps-mem" type="text" placeholder="e.g., 512Mi / 1Gi"/>
          <div class="inline-hint">Avoid OOM by sizing headroom.</div>
        </div>
        <div>
          <div class="label">Startup time / warmup</div>
          <input id="ps-warm" type="text" placeholder="e.g., 20s startup; 60s JIT warm"/>
          <div class="inline-hint">Used for probe delays & rollout pacing.</div>
        </div>
      </div>
    </div>
  
    <!-- 8.3 Autoscaling (K8s HPA) -->
    <div class="card">
      <h2>8.3 Autoscaling (K8s HPA)</h2>
      <div class="block row-3">
        <div>
          <div class="label">Min / Max replicas</div>
          <input id="ps-minrep" type="text" placeholder="e.g., 3"/>
          <input id="ps-maxrep" type="text" placeholder="e.g., 20" style="margin-top:6px"/>
        </div>
        <div>
          <div class="label">Primary HPA metric</div>
          <select id="ps-hpa-metric">
            <option>CPU %</option>
            <option>Memory %</option>
            <option>RPS per pod</option>
            <option>Custom (Prometheus/OTEL)</option>
          </select>
          <input id="ps-hpa-custom" class="hidden" type="text" placeholder="Metric name / query for custom"/>
        </div>
        <div>
          <div class="label">Target value</div>
          <input id="ps-hpa-target" type="text" placeholder="e.g., 70 (CPU%) or 120 (RPS/pod)"/>
        </div>
      </div>
    </div>
  
    <!-- 8.4 Concurrency & connection pools -->
    <div class="card">
      <h2>8.4 Concurrency & connection pools</h2>
      <div class="block">
        <table id="ps-pools" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Component</th><th>Max concurrency / pool</th><th>Timeout (ms)</th><th>Notes</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ps-add-pool">+ Add component</button>
        <div class="inline-hint">Examples: DB=50 conns; HTTP outbound=200; Broker consumer=20.</div>
      </div>
    </div>
  
    <!-- 8.5 Rate limiting -->
    <div class="card">
      <h2>8.5 Rate limiting</h2>
      <div class="block row-3">
        <div>
          <div class="label">Policy</div>
          <select id="ps-rl-policy">
            <option>None</option>
            <option>Token bucket</option>
            <option>Leaky bucket</option>
            <option>Fixed window</option>
            <option>Sliding window</option>
            <option>Other</option>
          </select>
          <input id="ps-rl-policy-custom" class="hidden" type="text" placeholder="Describe custom policy"/>
        </div>
        <div>
          <div class="label">Limit &amp; window</div>
          <input id="ps-rl-limit" type="text" placeholder="e.g., 100 req / 1s per user"/>
        </div>
        <div>
          <div class="label">Scope</div>
          <select id="ps-rl-scope">
            <option>Per user</option>
            <option>Per API key</option>
            <option>Per IP</option>
            <option>Per org/tenant</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- 8.6 Backpressure & overload protection -->
    <div class="card">
      <h2>8.6 Backpressure &amp; overload protection</h2>
      <div class="block row-3">
        <div>
          <div class="label">Strategy</div>
          <select id="ps-bp">
            <option>Queue with bounded size</option>
            <option>Drop/429 on overload</option>
            <option>Circuit breaker</option>
            <option>Adaptive concurrency</option>
            <option>Other</option>
          </select>
          <input id="ps-bp-custom" class="hidden" type="text" placeholder="Describe custom strategy"/>
        </div>
        <div>
          <div class="label">Queue / breaker thresholds</div>
          <input id="ps-bp-th" type="text" placeholder="e.g., queue 5k; CB open at 20% errors/30s"/>
        </div>
        <div>
          <div class="label">Fail behavior</div>
          <select id="ps-bp-fail">
            <option>Fast-fail (429/503)</option>
            <option>Graceful degrade</option>
            <option>Fallback path</option>
          </select>
        </div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 9: Testing Strategy === -->
<template id="tpl-step-9">
    <h2>Step 9 — Testing Strategy</h2>
    <p class="hint">API tests • Integration (by component) • Performance • Chaos/Resilience • Test data • CI/CD gates</p>
  
    <!-- 9.1 API Tests -->
    <div class="card">
      <h2>9.1 API Tests</h2>
      <div class="block row-3">
        <div>
          <div class="label">Primary tool</div>
          <select id="ts-api-tool">
            <option>Postman</option>
            <option>Newman (CI)</option>
            <option>REST Assured</option>
            <option>k6 (HTTP)</option>
            <option>Other</option>
          </select>
          <input id="ts-api-tool-custom" class="hidden" type="text" placeholder="Describe custom tool"/>
          <div class="inline-hint">Use Postman/Newman for collections; REST Assured for code-based; k6 for HTTP load smoke.</div>
        </div>
        <div>
          <div class="label">Coverage</div>
          <select id="ts-api-coverage">
            <option>Smoke</option>
            <option>Regression</option>
            <option>Contract (OpenAPI)</option>
            <option>Security (negative)</option>
          </select>
        </div>
        <div>
          <div class="label">Versioning / Broker</div>
          <input id="ts-api-versioning" type="text" placeholder="How versions are tested (headers/paths); brokered tests via gateway"/>
          <div class="inline-hint">E.g., test v1 & v2 routes; header-based routing; gateway policies.</div>
        </div>
      </div>
    </div>
  
    <!-- 9.2 Integration Tests (by component) -->
    <div class="card">
      <h2>9.2 Integration Tests (by component)</h2>
      <div class="block">
        <table id="ts-int" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Component</th>
              <th>Tool</th>
              <th>Config / Notes</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ts-add-int">+ Add component test</button>
        <div class="inline-hint">Component = DB, Cache, Message broker, External service, File store, Search.</div>
      </div>
    </div>
  
    <!-- 9.3 Performance Tests -->
    <div class="card">
      <h2>9.3 Performance Tests</h2>
      <div class="block row-3">
        <div>
          <div class="label">Tool</div>
          <select id="ts-perf-tool">
            <option>k6</option>
            <option>JMeter</option>
            <option>Locust</option>
            <option>Other</option>
          </select>
          <input id="ts-perf-tool-custom" class="hidden" type="text" placeholder="Describe custom tool"/>
        </div>
        <div>
          <div class="label">Scenarios</div>
          <select id="ts-perf-scen">
            <option>Baseline (steady)</option>
            <option>Spike</option>
            <option>Stress to saturation</option>
            <option>Soak (long run)</option>
          </select>
        </div>
        <div>
          <div class="label">Dataset</div>
          <input id="ts-perf-data" type="text" placeholder="Synthetic data size/shape; PII-safe; % cache hit expectations"/>
          <div class="inline-hint">What data you use and why it represents production.</div>
        </div>
      </div>
      <div class="block row-3">
        <div>
          <div class="label">Targets</div>
          <input id="ts-perf-targets" type="text" placeholder="e.g., p95&lt;300ms, error&lt;0.5%, 1.5k rps"/>
        </div>
        <div>
          <div class="label">Env</div>
          <select id="ts-perf-env">
            <option>Prod-like staging</option>
            <option>Isolated perf env</option>
            <option>Dev</option>
          </select>
        </div>
        <div>
          <div class="label">Reports / storage</div>
          <input id="ts-perf-reports" type="text" placeholder="Where results live (S3/Artifacts/Grafana)"/>
        </div>
      </div>
    </div>
  
    <!-- 9.4 Chaos / Resilience -->
    <div class="card">
      <h2>9.4 Chaos / Resilience</h2>
      <div class="block row-3">
        <div>
          <div class="label">Scenario</div>
          <select id="ts-chaos-scen">
            <option>Pod crash / restart</option>
            <option>Dependency latency injection</option>
            <option>Dependency failure (5xx)</option>
            <option>Network partition</option>
            <option>Node drain</option>
            <option>Custom</option>
          </select>
          <input id="ts-chaos-custom" class="hidden" type="text" placeholder="Describe custom chaos scenario"/>
        </div>
        <div>
          <div class="label">Blast radius</div>
          <select id="ts-chaos-blast">
            <option>Single pod</option>
            <option>Single AZ/zone</option>
            <option>Multi-AZ (controlled)</option>
          </select>
        </div>
        <div>
          <div class="label">Abort / rollback</div>
          <input id="ts-chaos-abort" type="text" placeholder="Abort criteria; rollback runbook link"/>
        </div>
      </div>
    </div>
  
    <!-- 9.5 Test Data Management -->
    <div class="card">
      <h2>9.5 Test Data Management</h2>
      <div class="block row-3">
        <div>
          <div class="label">Approach</div>
          <select id="ts-tdm-approach">
            <option>Synthetic only</option>
            <option>Masked prod subset</option>
            <option>Hybrid (seed + synthetic)</option>
          </select>
        </div>
        <div>
          <div class="label">Anonymization</div>
          <select id="ts-tdm-anon">
            <option>Tokenize</option>
            <option>Mask</option>
            <option>Hash</option>
            <option>Redact</option>
            <option>Custom</option>
          </select>
          <input id="ts-tdm-anon-custom" class="hidden" type="text" placeholder="Describe custom anonymization"/>
        </div>
        <div>
          <div class="label">Refresh cadence</div>
          <input id="ts-tdm-cad" type="text" placeholder="e.g., weekly snapshot; on-demand seeding"/>
        </div>
      </div>
    </div>
  
    <!-- 9.6 CI/CD Gates -->
    <div class="card">
      <h2>9.6 CI/CD Gates</h2>
      <div class="block">
        <table id="ts-gates" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Stage</th><th>Required tests</th><th>Pass criteria</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ts-add-gate">+ Add gate</button>
        <div class="inline-hint">Examples: PR → unit+API smoke; Staging → integration; Pre-prod → perf/chaos thresholds.</div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 10: Deployment === -->
<template id="tpl-step-10">
    <h2>Step 10 — Deployment</h2>
    <p class="hint">Kubernetes rollout strategy • Probes • Ingress/Gateway • Config/Secrets • Rollback • CI/CD hooks</p>
  
    <!-- 10.0 Tiny K8s Manifest Summary (read-only) -->
    <div class="card">
      <h2>10.0 K8s Manifest Summary</h2>
      <div class="block" id="k8s-mini-summary">
        <div class="inline-hint">Auto-filled from earlier steps where available (Performance &amp; Scalability, Security, API).</div>
        <div class="row-3">
          <div><div class="label">Replicas (target)</div><input id="mini-replicas" type="text" disabled/></div>
          <div><div class="label">CPU (req/limit)</div><input id="mini-cpu" type="text" disabled/></div>
          <div><div class="label">Memory (req/limit)</div><input id="mini-mem" type="text" disabled/></div>
        </div>
        <div class="row-3" style="margin-top:8px">
          <div><div class="label">HPA metric</div><input id="mini-hpa" type="text" disabled/></div>
          <div><div class="label">TLS</div><input id="mini-tls" type="text" disabled/></div>
          <div><div class="label">Auth Method</div><input id="mini-auth" type="text" disabled/></div>
        </div>
      </div>
    </div>
  
    <!-- 10.1 Workload & rollout -->
    <div class="card">
      <h2>10.1 Workload & Rollout</h2>
      <div class="block row-3">
        <div>
          <div class="label">Container image</div>
          <input id="dp-image" type="text" placeholder="registry/org/service:tag"/>
          <div class="inline-hint">E.g., gcr.io/acme/claims:1.2.3</div>
        </div>
        <div>
          <div class="label">Deployment type</div>
          <select id="dp-kind">
            <option>Deployment</option>
            <option>StatefulSet</option>
            <option>DaemonSet</option>
          </select>
        </div>
        <div>
          <div class="label">Rollout strategy</div>
          <select id="dp-rollout">
            <option>RollingUpdate</option>
            <option>Blue/Green</option>
            <option>Canary</option>
          </select>
        </div>
      </div>
  
      <div class="block row-3">
        <div>
          <div class="label">Replicas (min/max)</div>
          <input id="dp-replicas-min" type="text" placeholder="e.g., 3"/>
          <input id="dp-replicas-max" type="text" placeholder="e.g., 20" style="margin-top:6px"/>
        </div>
        <div>
          <div class="label">Rolling params</div>
          <input id="dp-rolling" type="text" placeholder="maxSurge=25%, maxUnavailable=25%"/>
        </div>
        <div>
          <div class="label">Canary / BG params</div>
          <input id="dp-canary" type="text" placeholder="e.g., 10%-30%-100% or preview svc"/>
        </div>
      </div>
    </div>
  
    <!-- 10.2 Probes -->
    <div class="card">
      <h2>10.2 Probes</h2>
      <div class="block row-3">
        <div>
          <div class="label">Liveness</div>
          <input id="dp-live" type="text" placeholder="HTTP GET /healthz | initialDelay=30s, period=10s"/>
        </div>
        <div>
          <div class="label">Readiness</div>
          <input id="dp-ready" type="text" placeholder="HTTP GET /ready | successThreshold=1"/>
        </div>
        <div>
          <div class="label">Startup (optional)</div>
          <input id="dp-start" type="text" placeholder="HTTP GET /startup | initialDelay=40s"/>
        </div>
      </div>
    </div>
  
    <!-- 10.3 Service & Ingress/Gateway -->
    <div class="card">
      <h2>10.3 Service & Ingress/Gateway</h2>
      <div class="block row-3">
        <div>
          <div class="label">Service type</div>
          <select id="dp-svc-type">
            <option>ClusterIP</option>
            <option>NodePort</option>
            <option>LoadBalancer</option>
          </select>
          <div class="inline-hint">Internal → ClusterIP; external → LB/Ingress/Gateway.</div>
        </div>
        <div>
          <div class="label">Ports</div>
          <input id="dp-ports" type="text" placeholder="HTTP=8080; gRPC=9090"/>
        </div>
        <div>
          <div class="label">Ingress / Gateway</div>
          <select id="dp-ing">
            <option>None</option>
            <option>Ingress</option>
            <option>Gateway API / Istio</option>
            <option>Other</option>
          </select>
          <input id="dp-ing-custom" class="hidden" type="text" placeholder="Custom ingress/gateway details"/>
        </div>
      </div>
    </div>
  
    <!-- 10.4 Config & Secrets -->
    <div class="card">
      <h2>10.4 Config & Secrets</h2>
      <div class="block row-3">
        <div>
          <div class="label">Config management</div>
          <select id="dp-cfg">
            <option>Helm</option>
            <option>Kustomize</option>
            <option>Plain manifests</option>
            <option>Other</option>
          </select>
          <input id="dp-cfg-custom" class="hidden" type="text" placeholder="Describe custom config approach"/>
        </div>
        <div>
          <div class="label">ConfigMaps (keys)</div>
          <input id="dp-cm" type="text" placeholder="e.g., app.yaml, routes.json"/>
        </div>
        <div>
          <div class="label">Secrets (refs)</div>
          <input id="dp-secrets" type="text" placeholder="e.g., db-cred, jwt-key (sealed/vault)"/>
        </div>
      </div>
    </div>
  
    <!-- 10.5 Scheduling & Resilience -->
    <div class="card">
      <h2>10.5 Scheduling & Resilience</h2>
      <div class="block row-3">
        <div>
          <div class="label">Node/affinity</div>
          <input id="dp-aff" type="text" placeholder="nodeSelector/affinity (e.g., zone=me-west1-b)"/>
        </div>
        <div>
          <div class="label">Tolerations</div>
          <input id="dp-tol" type="text" placeholder="e.g., dedicated=true:NoSchedule"/>
        </div>
        <div>
          <div class="label">PodDisruptionBudget</div>
          <input id="dp-pdb" type="text" placeholder="minAvailable=2 or maxUnavailable=1"/>
        </div>
      </div>
    </div>
  
    <!-- 10.6 Rollback & CI/CD -->
    <div class="card">
      <h2>10.6 Rollback & CI/CD</h2>
      <div class="block row-3">
        <div>
          <div class="label">Rollback criteria</div>
          <input id="dp-rollback" type="text" placeholder="e.g., error&gt;2%, p95&gt;800ms for 10m"/>
        </div>
        <div>
          <div class="label">Pipeline</div>
          <input id="dp-pipeline" type="text" placeholder="e.g., GitHub Actions / GitLab CI / Jenkins"/>
        </div>
        <div>
          <div class="label">Artifact registry</div>
          <input id="dp-registry" type="text" placeholder="e.g., GCR / ECR / ACR"/>
        </div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 11: Compliance & Governance === -->
<template id="tpl-step-11">
    <h2>Step 11 — Compliance &amp; Governance</h2>
    <p class="hint">Regulatory scope • Data residency/retention • Control mapping • Evidence • Reviews • Exceptions/Risks</p>
  
    <!-- 11.1 Regulatory Scope -->
    <div class="card">
      <h2>11.1 Regulatory Scope</h2>
      <div class="block row-3">
        <div>
          <div class="label">Frameworks / Regulations</div>
          <select id="cg-regs" multiple>
            <option>GDPR</option>
            <option>PCI DSS</option>
            <option>HIPAA</option>
            <option>ISO 27001</option>
            <option>SOC 2</option>
            <option>Local privacy law</option>
            <option>Other</option>
          </select>
          <input id="cg-regs-custom" class="hidden" type="text" placeholder="Add details for 'Other'"/>
          <div class="inline-hint">Hold Ctrl/Cmd to select multiple.</div>
        </div>
        <div>
          <div class="label">Data classification</div>
          <select id="cg-class">
            <option>Public</option>
            <option>Internal</option>
            <option>Confidential</option>
            <option>Restricted/PII</option>
          </select>
        </div>
        <div>
          <div class="label">DPIA / PIA required?</div>
          <select id="cg-dpia">
            <option>No</option>
            <option>Yes</option>
            <option>In progress</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- 11.2 Data Residency & Retention -->
    <div class="card">
      <h2>11.2 Data Residency &amp; Retention</h2>
      <div class="block row-3">
        <div>
          <div class="label">Residency / region</div>
          <input id="cg-residency" type="text" placeholder="e.g., me-west1 (Israel) only"/>
        </div>
        <div>
          <div class="label">Retention (business)</div>
          <input id="cg-retention" type="text" placeholder="e.g., PII 7y, logs 1y"/>
        </div>
        <div>
          <div class="label">WORM / Legal hold</div>
          <select id="cg-worm">
            <option>None</option>
            <option>WORM (bucket-level)</option>
            <option>Legal hold on demand</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- 11.3 Encryption & Secrets -->
    <div class="card">
      <h2>11.3 Encryption &amp; Secrets</h2>
      <div class="block row-3">
        <div>
          <div class="label">At rest</div>
          <select id="cg-rest">
            <option>Provider-managed keys</option>
            <option>CMEK (customer-managed)</option>
            <option>HSM-backed (Cloud KMS/HSM)</option>
          </select>
        </div>
        <div>
          <div class="label">In transit</div>
          <select id="cg-transit">
            <option>TLS 1.2+</option>
            <option>TLS 1.3</option>
            <option>mTLS (internal)</option>
          </select>
        </div>
        <div>
          <div class="label">Secret management</div>
          <select id="cg-secrets">
            <option>Cloud Secret Manager</option>
            <option>Vault</option>
            <option>K8s sealed secrets</option>
            <option>Other</option>
          </select>
          <input id="cg-secrets-custom" class="hidden" type="text" placeholder="Describe 'Other'"/>
        </div>
      </div>
    </div>
  
    <!-- 11.4 Control Mapping & Evidence -->
    <div class="card">
      <h2>11.4 Control Mapping &amp; Evidence</h2>
      <div class="block">
        <table id="cg-controls" style="width:100%;border-collapse:collapse">
          <thead><tr>
            <th>Control (ref)</th>
            <th>Implementation (how enforced)</th>
            <th>Evidence (where/how)</th>
            <th style="width:40px"></th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="cg-add-ctrl">+ Add control</button>
        <div class="inline-hint">Example: “GDPR-32 encryption” → CMEK @ DB + TLS 1.3; Evidence: policy, KMS key, config screenshot, automated check.</div>
      </div>
    </div>
  
    <!-- 11.5 Reviews & Audits -->
    <div class="card">
      <h2>11.5 Reviews &amp; Audits</h2>
      <div class="block row-3">
        <div>
          <div class="label">Access reviews cadence</div>
          <select id="cg-access">
            <option>Monthly</option>
            <option>Quarterly</option>
            <option>Semiannual</option>
            <option>Annual</option>
          </select>
        </div>
        <div>
          <div class="label">Security audit trail</div>
          <select id="cg-audittrail">
            <option>SIEM</option>
            <option>Central log pipeline</option>
            <option>External archive</option>
            <option>Other</option>
          </select>
          <input id="cg-audittrail-custom" class="hidden" type="text" placeholder="Describe 'Other'"/>
        </div>
        <div>
          <div class="label">Data subject requests (DSR) process</div>
          <select id="cg-dsr">
            <option>Documented runbook</option>
            <option>Ticket workflow</option>
            <option>Both</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- 11.6 Exceptions & Risks -->
    <div class="card">
      <h2>11.6 Exceptions &amp; Risks</h2>
      <div class="block">
        <table id="cg-exc" style="width:100%;border-collapse:collapse">
          <thead><tr>
            <th>Type</th><th>Description</th><th>Owner</th><th>Mitigation / Expiry</th><th style="width:40px"></th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="cg-add-exc">+ Add exception/risk</button>
        <div class="inline-hint">Type examples: Policy exception, Compensating control, Risk accepted.</div>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
  <!-- === STEP 12: Decisions, Open Questions & Review/Approval === -->
<template id="tpl-step-12">
    <h2>Step 12 — Decisions, Open Questions &amp; Review / Approval</h2>
    <p class="hint">Record major design decisions, unresolved items, and document review sign-off.</p>
  
    <!-- 12.1 Design Decisions -->
    <div class="card">
      <h2>12.1 Design Decisions</h2>
      <div class="block">
        <table id="fc-decisions" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Decision Description</th>
              <th>Rationale</th>
              <th>Date</th>
              <th>Decided By</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="fc-add-decision">+ Add Decision</button>
        <div class="inline-hint">Each record describes a key architectural or operational decision and its reasoning.</div>
      </div>
    </div>
  
    <!-- 12.2 Open Questions -->
    <div class="card">
      <h2>12.2 Open Questions</h2>
      <div class="block">
        <table id="fc-questions" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Question</th>
              <th>Directed To</th>
              <th>Due Date</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Notes</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="fc-add-question">+ Add Question</button>
        <div class="inline-hint">Track unanswered or follow-up questions and assign owners.</div>
      </div>
    </div>
  
    <!-- 12.3 Review & Approval -->
    <div class="card">
      <h2>12.3 Review &amp; Approval</h2>
      <div class="block">
        <div class="label">Checklist</div>
        <table id="fc-checklist" style="width:100%;border-collapse:collapse">
          <thead>
            <tr><th>Item</th><th>Complete?</th></tr>
          </thead>
          <tbody>
            <tr><td>Business context &amp; service purpose reviewed</td><td><input type="checkbox"/></td></tr>
            <tr><td>API specifications and idempotency confirmed</td><td><input type="checkbox"/></td></tr>
            <tr><td>Messaging and event schemas validated</td><td><input type="checkbox"/></td></tr>
            <tr><td>Data storage and caching verified</td><td><input type="checkbox"/></td></tr>
            <tr><td>Security controls tested</td><td><input type="checkbox"/></td></tr>
            <tr><td>Observability &amp; performance targets checked</td><td><input type="checkbox"/></td></tr>
            <tr><td>Testing and deployment plans approved</td><td><input type="checkbox"/></td></tr>
            <tr><td>Compliance evidence attached</td><td><input type="checkbox"/></td></tr>
          </tbody>
        </table>
      </div>
  
      <div class="block">
        <div class="label">Approvals</div>
        <table id="fc-approvals" style="width:100%;border-collapse:collapse">
          <thead><tr><th>Role</th><th>Name</th><th>Decision</th><th>Date</th><th>Comments</th><th style="width:40px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="fc-add-approval">+ Add Approver</button>
      </div>
    </div>
  
    <div class="controls">
      <button type="button" class="btn-sec" data-prev>← Back</button>
      <button type="button" class="btn" id="fc-export-doc">Export .docx</button>
    </div>
  </template>
<!-- ======== INSERT NEXT STEP PACKS BELOW (I will refer to this marker) ======== -->
<!-- === STEP 4: Data Storage === -->
<template id="tpl-step-4">
    <h2>Step 4 — Data Storage</h2>
    <p class="hint">DB engine • Rationale • Schema • Retention • Backup & Recovery • Indexing/Partitioning/Sharding • Encryption</p>
  
    <!-- 5.1 DB Choice & Rationale -->
    <div class="card">
      <h2>4.1 Database Choice & Rationale</h2>
      <div class="block row-3">
        <div>
          <div class="label">Database Engine</div>
          <select data-k="dbEngine" id="ds-dbEngine">
            <option>Postgres</option>
            <option>MongoDB</option>
            <option>MSSQL</option>
          </select>
        </div>
        <div>
          <div class="label">Environment / Cluster (optional)</div>
          <input type="text" data-k="dbCluster" placeholder="e.g., prod-sql-01 / atlas-cluster-x"/>
        </div>
        <div>
          <div class="label">Connection String (redacted)</div>
          <input type="text" data-k="connString" placeholder="Use secrets manager; redact passwords"/>
        </div>
      </div>
      <div class="block">
        <div class="label">Rationale for choice</div>
        <textarea class="tall" data-k="dbRationale" placeholder="Why this DB fits (workload, transactions, scale, team skill, ops)"></textarea>
      </div>
    </div>
  
    <!-- 5.2 Schema -->
    <div class="card">
      <h2>4.2 Schema</h2>
      <div class="block row-3">
        <div>
          <div class="label">Schema Source</div>
          <select id="ds-schemaSource">
            <option>Upload file</option>
            <option>Inline editor</option>
          </select>
        </div>
        <div>
          <div class="label">Allowed Formats (by DB)</div>
          <div class="expl">
            Postgres/MSSQL: <b>.sql</b><br/>
            MongoDB: <b>.json</b>, <b>.yaml</b>, <b>.yml</b>
          </div>
        </div>
        <div>
          <div class="label">Schema Version (optional)</div>
          <input type="text" data-k="schemaVersion" placeholder="e.g., 1.0.0"/>
        </div>
      </div>
      <div class="block" id="ds-uploadWrap">
        <div class="label">Upload schema file</div>
        <input type="file" id="ds-schemaFile" />
        <div class="expl">Only the file name is stored in JSON (not file contents).</div>
      </div>
      <div class="block hidden" id="ds-inlineWrap">
        <div class="label">Inline schema editor</div>
        <textarea class="tall" id="ds-schemaInline" placeholder="Paste DDL (.sql) for Postgres/MSSQL, or JSON/YAML schema for MongoDB"></textarea>
      </div>
    </div>
  
    <!-- 5.3 Data Retention -->
    <div class="card">
      <h2>4.3 Data Retention</h2>
      <div class="block">
        <table id="ds-retTable">
          <thead>
            <tr>
              <th>Table / Collection</th>
              <th>Retention</th>
              <th>Deletion Strategy</th>
              <th>Legal Hold?</th>
              <th>Notes</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-mini" id="ds-addRet">+ Add retention rule</button>
        <div class="expl" style="margin-top:.5rem">Examples: <i>claims</i> → 7y, “soft delete” &amp; archive; <i>temp_jobs</i> → 30d hard delete.</div>
      </div>
    </div>
  
    <!-- 5.4 Backup & Recovery -->
    <div class="card">
      <h2>4.4 Backup & Recovery</h2>
      <div class="block row-3">
        <div>
          <div class="label">Backup Strategy (multi-select)</div>
          <div class="block">
            <label><input type="checkbox" class="ds-bak" value="full-daily"/> Full daily</label><br/>
            <label><input type="checkbox" class="ds-bak" value="incr-hourly"/> Incremental hourly</label><br/>
            <label><input type="checkbox" class="ds-bak" value="pitr"/> Point-in-time recovery (WAL/LSN)</label><br/>
            <label><input type="checkbox" class="ds-bak" value="cross-region"/> Cross-region replica/backup</label><br/>
            <label><input type="checkbox" class="ds-bak" value="restore-verify"/> Monthly restore verification (“game day”)</label><br/>
            <label><input type="checkbox" class="ds-bak" value="dr-runbook"/> DR runbook tested</label>
          </div>
        </div>
        <div>
          <div class="label">RPO / RTO</div>
          <div class="row-2">
            <input type="text" data-k="rpo" placeholder="e.g., 15m (max data loss)"/>
            <input type="text" data-k="rto" placeholder="e.g., 60m (max downtime)"/>
          </div>
          <div class="inline-hint">Keep realistic per environment (prod vs. non-prod).</div>
        </div>
        <div>
          <div class="label">Backup Window / Notes</div>
          <textarea data-k="backupNotes" placeholder="Window (UTC), bandwidth constraints, storage class, etc."></textarea>
        </div>
      </div>
    </div>
  
    <!-- 5.5 Indexing / Partitioning / Sharding -->
    <div class="card">
      <h2>4.5 Indexing / Partitioning / Sharding</h2>
      <div class="block">
        <div class="label">Structure (adapts to DB engine)</div>
        <div id="ds-structWrap"></div>
      </div>
    </div>
  
    <!-- 5.6 Encryption -->
    <div class="card">
      <h2>4.6 Encryption</h2>
      <div class="block row-3">
        <div>
          <div class="label">At-rest encryption</div>
          <select data-k="encRest">
            <option>Enabled (managed key)</option>
            <option>Enabled (customer-managed KMS)</option>
          </select>
          <div class="inline-hint">Prefer CMK for regulated environments.</div>
        </div>
        <div>
          <div class="label">KMS Key / Alias</div>
          <input type="text" data-k="kmsKey" placeholder="e.g., projects/x/locations/y/keyRings/z/cryptoKeys/k"/>
        </div>
        <div>
          <div class="label">In-transit encryption (TLS)</div>
          <select data-k="encTransit">
            <option>TLS 1.2+</option>
            <option>TLS 1.3</option>
            <option>Custom</option>
          </select>
        </div>
      </div>
      <div class="block hidden" id="ds-transitCustom">
        <div class="label">TLS custom details</div>
        <input type="text" data-k="tlsCustom" placeholder="ciphers, mTLS, cert rotation policy"/>
      </div>
    </div>
  
    <div class="controls">
        <button type="button" class="btn-sec" data-prev>← Back</button>
        <button type="button" class="btn" data-next>Next</button>
    </div>
  </template>
<script>
/* =========================
   SHELL CORE (Back/Next hardened)
========================= */
const LS_KEY='msd_steps_1_2_state';
// When true, navigation won't serialize current step (used during import/clear)
window.__suppressSerialize = false;
const steps=[];
let active=0;
const state={};

const id=s=>document.getElementById(s);
function toast(msg){const t=id('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',1500);}

function registerStep(def){ steps.push(def); }
function buildNav(){
  const nav=id('nav'); nav.innerHTML='';
  steps.forEach((s,i)=>{
    const el=document.createElement('div');
    el.className='step-pill'+(i===active?' active':'');
    el.innerHTML=`<div class="step-index">${i+1}</div><div>${s.title}</div>`;
    el.onclick=()=>go(i);
    nav.appendChild(el);
  });
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function go(i){
  const mountEl = document.getElementById('stepMount');

  // autoserialize current step before switching — only if something is mounted
  try{
    if (!window.__suppressSerialize && mountEl && mountEl.childElementCount > 0 && steps[active]?.serialize){
      const key = steps[active].id;
      const tgt = state[key] = state[key] || {};
      steps[active].serialize(tgt, mountEl);
    }
  }catch(e){
    console.warn('serialize skipped due to guard:', e);
  }

  // clamp index and render
  active = Math.max(0, Math.min(i, steps.length - 1));
  buildNav();

  mountEl.innerHTML = '';
  const step = steps[active];
  const data = state[step.id] || (state[step.id] = {});

  step.mount(mountEl, data, {
    next: ()=>go(active + 1),
    prev: ()=>go(active - 1)
  });

  // ensure buttons never submit
  mountEl.querySelectorAll('[data-prev],[data-next]').forEach(btn=>{
    btn.setAttribute('type','button');
  });

  // ===== Global prev/next state & label =====
  const prevBtn = mountEl.querySelector('[data-prev]');
  if (prevBtn){
    prevBtn.disabled = (active === 0);
  }

  const nextBtn = mountEl.querySelector('[data-next]');
  if (nextBtn){
    if (active < steps.length - 1){
      nextBtn.disabled = false;
      // Build a friendly label from the next step's title
      const raw = steps[active + 1].title || 'Next';
      const nice = raw.replace(/^Step\s*\d+\s*[—-]\s*/,''); // strip "Step N — "
      nextBtn.textContent = 'Next → ' + nice;
    } else {
      nextBtn.disabled = true;
      nextBtn.textContent = 'Finish';
    }
  }
}

// ----- Save / Export / Load -----
function saveProgress(){
  try{
    if(steps[active]?.serialize){
      const key=steps[active].id;
      const tgt = state[key] = state[key] || {};
      steps[active].serialize(tgt, id('stepMount'));
    }
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    toast('Progress saved');
  }catch(e){ console.error(e); toast('Save failed'); }
}
function exportJson(){
  try{
    // Serialize current step if mounted (safe when no fields yet)
    try{
      if(steps[active]?.serialize && id('stepMount')?.childElementCount){
        const key=steps[active].id;
        const tgt = state[key] = state[key] || {};
        steps[active].serialize(tgt, id('stepMount'));
      }
    }catch(_){/* ignore */}
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='microservice_design_steps_1_2.json';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
    toast('Exported JSON');
  }catch(e){ console.error(e); toast('Export failed'); }
}
function importJsonFile(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json,.json';
  inp.onchange=()=>{const f=inp.files[0]; if(!f) return; const r=new FileReader();
    r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      // Replace entire state with imported object to avoid partial merges
      for(const k of Object.keys(state)) delete state[k];
      Object.keys(obj||{}).forEach(k=>state[k]=obj[k]);
      // Rebuild and start from first step
      try{ buildNav(); }catch(_){ }
      // Walk all steps to ensure UI is hydrated from imported state, then return to step 0
      (function rehydrateAll(){
        try{
          window.__suppressSerialize = true;
          for(let i=0;i<steps.length;i++){
            go(i);
            const step = steps[i];
            const data = state[step.id] || {};
            // Fill simple inputs mapped by data-k
            document.querySelectorAll('[data-k]').forEach(el=>{
              const key = el.getAttribute('data-k');
              if (Object.prototype.hasOwnProperty.call(data, key)){
                el.value = data[key] ?? '';
                el.dispatchEvent(new Event('input', { bubbles:true }));
                el.dispatchEvent(new Event('change', { bubbles:true }));
              }
            });
          }
        }catch(_){ }
        // Return to first step for user convenience
        go(0);
        window.__suppressSerialize = false;
      })();
      toast('Loaded JSON');
    }catch(e){ console.error(e); toast('Invalid JSON'); } };
    r.readAsText(f);
  };
  inp.click();
}

// Clear all data across steps, reset local storage, and re-render from step 0
function clearForm(){
  try{
    try{ localStorage.removeItem(LS_KEY); }catch(_){ }
    try{ for(const k of Object.keys(state||{})) delete state[k]; }catch(_){ window.state = {}; }
    try{ buildNav(); }catch(_){ }
    // Re-render first step
    window.__suppressSerialize = true;
    go(0);
    // After mount, force-clear all user-editable fields to avoid browser autofill remnants
    setTimeout(()=>{
      try{
        // text/date/textarea
        document.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el=>{
          el.value = '';
          el.dispatchEvent(new Event('input', { bubbles:true }));
          el.dispatchEvent(new Event('change', { bubbles:true }));
        });
        // file inputs
        document.querySelectorAll('input[type="file"]').forEach(el=>{
          el.value = '';
          try{ el.removeAttribute('data-display'); }catch(_){ }
          el.dispatchEvent(new Event('change', { bubbles:true }));
        });
        // checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          cb.checked = false;
          cb.dispatchEvent(new Event('change', { bubbles:true }));
        });
        // selects
        document.querySelectorAll('select').forEach(sel=>{
          if (sel.options && sel.options.length){ sel.selectedIndex = 0; }
          sel.dispatchEvent(new Event('change', { bubbles:true }));
        });

        // Clear dynamic tables/containers if present on the current DOM
        const clearTbs = [
          '#respTable tbody', '#ngoalTable tbody', '#useCasesTable tbody', '#epTable tbody',
          '#ds-retTable tbody', '#sec-auth-scopes tbody', '#sec-authz-matrix tbody',
          '#sec-pii tbody', '#sec-mask tbody', '#ob-metrics tbody', '#ob-dash tbody',
          '#ob-alerts tbody', '#ob-logs tbody', '#ps-pools tbody', '#ts-int tbody',
          '#ts-gates tbody', '#cg-controls tbody', '#cg-exc tbody', '#fc-decisions tbody',
          '#fc-questions tbody', '#fc-approvals tbody'
        ];
        clearTbs.forEach(sel=>{ const tb=document.querySelector(sel); if(tb){ tb.innerHTML=''; }});
        const containers = ['#pubWrap', '#conWrap', '#ds-structWrap'];
        containers.forEach(sel=>{ const c=document.querySelector(sel); if(c){ c.innerHTML=''; }});
      }catch(_){ }
      window.__suppressSerialize = false;
      const t=document.getElementById('toast'); if(t){ t.textContent='Form cleared'; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
    }, 0);
  }catch(e){ console.error(e); }
}
document.getElementById('btnExportJson').onclick=exportJson;
document.getElementById('btnLoad').onclick=importJsonFile;
document.getElementById('btnMock').onclick=loadMockData;
document.getElementById('btnClear').onclick=clearForm;

// helper
function setTodayIfEmpty(inputEl){
  if(!inputEl) return;
  if(!inputEl.value){
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    inputEl.value=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  }
}

// ----- Global delegated handlers for nav buttons -----
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-prev],[data-next]');
  if(!btn) return;
  e.preventDefault();
  const dir = btn.hasAttribute('data-prev') ? -1 : 1;
  go(active + dir);
});

// ----- Inline fallback handlers exposed for templates -----
window.__navPrev = ()=> go(active - 1);
window.__navNext = ()=> go(active + 1);

/* =========================
   STEP 1: Service Overview
========================= */
registerStep({
  id:'service_overview',
  title:'Service Overview',
  mount(root, data, nav){
    const tpl=document.getElementById('tpl-step-1');
    root.appendChild(tpl.content.cloneNode(true));

    // hydrate
    root.querySelectorAll('[data-k]').forEach(el=>{
      const k=el.getAttribute('data-k');
      if(data[k]!=null) el.value=data[k];
      if(k==='svcDate') setTodayIfEmpty(el);
    });

    // Responsibilities
    const respTb = root.querySelector('#respTable tbody');
    const addResp = (preset={})=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${preset.name||''}" placeholder="e.g., Validate claim inputs"/></td>
        <td><input type="text" value="${preset.notes||''}" placeholder="Optional notes"/></td>
        <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`;
      respTb.appendChild(tr);
    };
    root.querySelector('#btnAddResp').onclick=()=>addResp();
    (Array.isArray(data.responsibilities)&&data.responsibilities.length?data.responsibilities:[{}]).forEach(addResp);

    // Non-goals
    const ngoalTb = root.querySelector('#ngoalTable tbody');
    const addNGoal = (preset={})=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${preset.text||''}" placeholder="e.g., Process payments (owned by Billing Service)"/></td>
        <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`;
      ngoalTb.appendChild(tr);
    };
    root.querySelector('#btnAddNGoal').onclick=()=>addNGoal();
    (Array.isArray(data.nonGoals)&&data.nonGoals.length?data.nonGoals:[{}]).forEach(addNGoal);

    // Use cases
    const ucTb=root.querySelector('#useCasesTable tbody');
    const addUC=(preset={})=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input type="text" value="${preset.name||''}"/></td>
                    <td><input type="text" value="${preset.actor||''}"/></td>
                    <td><input type="text" value="${preset.outcome||''}"/></td>
                    <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`;
      ucTb.appendChild(tr);
    };
    root.querySelector('#btnAddUseCase').onclick=()=>addUC();
    (Array.isArray(data.useCases)&&data.useCases.length?data.useCases:[{}]).forEach(addUC);
  },
  serialize(target, root){
    root.querySelectorAll('[data-k]').forEach(el=>{
      const k=el.getAttribute('data-k'); target[k]=el.value||'';
    });
    target.responsibilities = Array.from(root.querySelectorAll('#respTable tbody tr')).map(tr=>({
      name: tr.children[0].querySelector('input').value,
      notes: tr.children[1].querySelector('input').value
    })).filter(r=>r.name?.trim().length);
    target.nonGoals = Array.from(root.querySelectorAll('#ngoalTable tbody tr')).map(tr=>({
      text: tr.children[0].querySelector('input').value
    })).filter(n=>n.text?.trim().length);
    target.externalBoundaries = root.querySelector('[data-k="externalBoundaries"]')?.value || '';
    target.useCases = Array.from(root.querySelectorAll('#useCasesTable tbody tr')).map(tr=>({
      name: tr.children[0].querySelector('input').value,
      actor: tr.children[1].querySelector('input').value,
      outcome: tr.children[2].querySelector('input').value
    })).filter(u=>u.name?.trim().length);
  }
});

/* =========================
   STEP 2: API Specifications (REST)
========================= */
(function(){
  const ERR_CODES = ['400','401','403','404','409','415','422','429','500','502','503'];

  function idempotencyConfigHTML(){ return `
    <div class="block">
      <div class="row-2">
        <div>
          <div class="label">Idempotency Method</div>
          <select class="idem-method">
            <option>Idempotency-Key header</option>
            <option>Deterministic business key</option>
            <option>Request body hash</option>
            <option>Custom</option>
          </select>
          <input class="idem-method-custom hidden" type="text" placeholder="Describe custom method"/>
          <div class="expl">How the service recognizes duplicate requests.</div>
        </div>
        <div>
          <div class="label">Idempotency Key Source</div>
          <input class="idem-key-src" type="text" placeholder="e.g., X-Idempotency-Key or business key"/>
          <div class="expl">How we detect “same request”.</div>
        </div>
      </div>

      <div class="row-2" style="margin-top:10px">
        <div>
          <div class="label">Key Storage</div>
          <select class="idem-store">
            <option>Redis (TTL)</option>
            <option>Database table</option>
            <option>In-memory (non-prod)</option>
            <option>Custom</option>
          </select>
          <input class="idem-store-custom hidden" type="text" placeholder="Storage details"/>
          <div class="expl">Where idempotency keys/results are stored.</div>
        </div>
        <div>
          <div class="label">TTL</div>
          <input class="idem-ttl" type="text" placeholder="e.g., 24h"/>
          <div class="expl">How long idempotency is guaranteed.</div>
        </div>
      </div>

      <div class="row-2" style="margin-top:10px">
        <div>
          <div class="label">Duplicate Behavior</div>
          <select class="idem-dup">
            <option>Return cached response (same status)</option>
            <option>Return 200 OK with previous result</option>
            <option>Reject with 409 Conflict</option>
            <option>Custom</option>
          </select>
          <input class="idem-dup-custom hidden" type="text" placeholder="Describe custom duplicate behavior"/>
          <div class="expl">What happens if the same request is received again.</div>
        </div>
        <div>
          <div class="label">Client Retry Guidance</div>
          <select class="idem-retry">
            <option>Exponential backoff (max 3)</option>
            <option>Exponential backoff (max 5)</option>
            <option>Fixed interval (2s ×3)</option>
            <option>None</option>
            <option>Custom</option>
          </select>
          <input class="idem-retry-custom hidden" type="text" placeholder="Describe custom retry guidance"/>
          <div class="expl">How clients should retry safely.</div>
        </div>
      </div>

      <div class="row-2" style="margin-top:10px">
        <div>
          <div class="label">Timeout / Max Processing Window</div>
          <input class="idem-timeout" type="text" placeholder="e.g., 30s"/>
          <div class="expl">Server “in-flight” time (distinct from endpoint SLA).</div>
        </div>
        <div>
          <div class="label">Rate Limiting</div>
          <input class="idem-rl" type="text" placeholder="e.g., 100 req/min per user"/>
          <div class="expl">Request limits if applicable.</div>
        </div>
      </div>
    </div>
  `;}

  function errorTableHTML(){ return `
    <table class="errTable" style="width:100%;border-collapse:collapse;margin-top:6px">
      <thead><tr><th style="width:120px">HTTP Code</th><th>Meaning</th><th style="width:40px"></th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn-mini addErr">+ Add error</button>
  `;}

  function addErrorRow(errTbody, preset){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><select class="err-code">${ERR_CODES.map(c=>`<option ${preset?.code===c?'selected':''}>${c}</option>`).join('')}</select></td>
      <td><input class="err-meaning" type="text" placeholder="Meaning, e.g., Validation failed" value="${preset?.meaning?String(preset.meaning).replace(/"/g,'&quot;'):''}"/></td>
      <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
    `;
    errTbody.appendChild(tr);
  }

  function addEndpointRow(tbody, preset){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input class="ep-path" type="text" placeholder="/claims/{id}" value="${preset?.path?String(preset.path).replace(/"/g,'&quot;'):''}"/></td>
      <td>
        <select class="ep-method">
          <option ${preset?.method==='GET'?'selected':''}>GET</option>
          <option ${preset?.method==='POST'?'selected':''}>POST</option>
          <option ${preset?.method==='PUT'?'selected':''}>PUT</option>
          <option ${preset?.method==='DELETE'?'selected':''}>DELETE</option>
        </select>
      </td>
      <td>
        <select class="ep-idem">
          <option ${preset?.idempotent===true?'selected':''}>Yes</option>
          <option ${preset?.idempotent===false?'selected':''}>No</option>
        </select>
      </td>
      <td class="idem-cell">${idempotencyConfigHTML()}</td>
      <td class="err-cell">${errorTableHTML()}</td>
      <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
    `;
    tbody.appendChild(tr);

    // defaults by method
    const methodSel = tr.querySelector('.ep-method');
    const idemSel   = tr.querySelector('.ep-idem');
    const idemWrap  = tr.querySelector('.idem-cell .block');

    function applyDefaults(){
      const m=methodSel.value;
      if(!preset){
        if(m==='GET'||m==='PUT'||m==='DELETE'){ idemSel.value='Yes'; }
        if(m==='POST'){ idemSel.value='No'; }
      }
      showHideIdem();
    }
    function showHideIdem(){
      const m=methodSel.value;
      const isYes = idemSel.value==='Yes';
      // show advanced if idempotent AND (POST|PUT|DELETE); hide for GET
      idemWrap.classList.toggle('hidden', !(isYes && (m==='POST'||m==='PUT'||m==='DELETE')));
    }
    methodSel.addEventListener('change',applyDefaults);
    idemSel.addEventListener('change',showHideIdem);
    applyDefaults();

    // custom toggles
    tr.querySelector('.idem-method').addEventListener('change',e=>tr.querySelector('.idem-method-custom').classList.toggle('hidden',e.target.value!=='Custom'));
    tr.querySelector('.idem-store').addEventListener('change',e=>tr.querySelector('.idem-store-custom').classList.toggle('hidden',e.target.value!=='Custom'));
    tr.querySelector('.idem-dup').addEventListener('change',e=>tr.querySelector('.idem-dup-custom').classList.toggle('hidden',e.target.value!=='Custom'));
    tr.querySelector('.idem-retry').addEventListener('change',e=>tr.querySelector('.idem-retry-custom').classList.toggle('hidden',e.target.value!=='Custom'));

    // errors
    const errTbody = tr.querySelector('.errTable tbody');
    tr.querySelector('.addErr').addEventListener('click',()=>addErrorRow(errTbody));
    if(preset?.errors?.length){
      preset.errors.forEach(er=>addErrorRow(errTbody, er));
    }else{
      addErrorRow(errTbody);
    }

    // hydrate idempotency preset
    if(preset?.idempotency){
      const p=preset.idempotency;
      tr.querySelector('.idem-method').value=p.method||'Idempotency-Key header';
      tr.querySelector('.idem-method').dispatchEvent(new Event('change'));
      if(p.methodCustom){ const el=tr.querySelector('.idem-method-custom'); el.classList.remove('hidden'); el.value=p.methodCustom; }
      tr.querySelector('.idem-key-src').value=p.keySource||'';
      tr.querySelector('.idem-store').value=p.store||'Redis (TTL)';
      tr.querySelector('.idem-store').dispatchEvent(new Event('change'));
      if(p.storeCustom){ const el=tr.querySelector('.idem-store-custom'); el.classList.remove('hidden'); el.value=p.storeCustom; }
      tr.querySelector('.idem-ttl').value=p.ttl||'';
      tr.querySelector('.idem-dup').value=p.duplicate||'Return cached response (same status)';
      tr.querySelector('.idem-dup').dispatchEvent(new Event('change'));
      if(p.duplicateCustom){ const el=tr.querySelector('.idem-dup-custom'); el.classList.remove('hidden'); el.value=p.duplicateCustom; }
      tr.querySelector('.idem-retry').value=p.retry||'Exponential backoff (max 3)';
      tr.querySelector('.idem-retry').dispatchEvent(new Event('change'));
      if(p.retryCustom){ const el=tr.querySelector('.idem-retry-custom'); el.classList.remove('hidden'); el.value=p.retryCustom; }
      tr.querySelector('.idem-timeout').value=p.timeout||'';
      tr.querySelector('.idem-rl').value=p.rateLimit||'';
      showHideIdem();
    }
  }

  registerStep({
    id:'api_specs',
    title:'API Specifications (REST)',
    mount(root, data, nav){
      const tpl=document.getElementById('tpl-step-2');
      root.appendChild(tpl.content.cloneNode(true));

      // swagger file names (display only in JSON)
      const inF = root.querySelector('[data-k="swaggerInFile"]');
      const outF= root.querySelector('[data-k="swaggerOutFile"]');
      if(data.swaggerInName){ inF.setAttribute('data-display', data.swaggerInName); }
      if(data.swaggerOutName){ outF.setAttribute('data-display', data.swaggerOutName); }
      inF.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) data.swaggerInName=f.name; });
      outF.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) data.swaggerOutName=f.name; });

      // endpoints table
      const tb = root.querySelector('#epTable tbody');
      const addBtn = root.querySelector('#btnAddEndpoint');
      addBtn.addEventListener('click', ()=> addEndpointRow(tb));

      const existing = Array.isArray(data.endpoints)
  ? data.endpoints.filter(ep => ep && (ep.path||'').trim().length > 0)
  : [];
if (existing.length){
  existing.forEach(ep=>addEndpointRow(tb, ep));
} else {
  // only add a single starter row when there's truly nothing saved
  addEndpointRow(tb);
}
    },
    serialize(target, root){
  // swagger filenames
  const inF  = root.querySelector('[data-k="swaggerInFile"]');
  const outF = root.querySelector('[data-k="swaggerOutFile"]');
  if (inF  && inF.files  && inF.files[0])  target.swaggerInName  = inF.files[0].name;
  if (outF && outF.files && outF.files[0]) target.swaggerOutName = outF.files[0].name;

  // endpoints (null-safe + filter out empties)
  const rows = Array.from(root.querySelectorAll('#epTable tbody tr'));
  const mapped = rows.map(row=>{
    const idemBlock   = row.querySelector('.idem-cell .block');
    const idemVisible = !!(idemBlock && !idemBlock.classList.contains('hidden'));

    const idem = idemVisible ? {
      method:        row.querySelector('.idem-method')?.value || '',
      methodCustom:  !(row.querySelector('.idem-method-custom')?.classList?.contains('hidden')) ? (row.querySelector('.idem-method-custom')?.value || '') : '',
      keySource:     row.querySelector('.idem-key-src')?.value || '',
      store:         row.querySelector('.idem-store')?.value || '',
      storeCustom:   !(row.querySelector('.idem-store-custom')?.classList?.contains('hidden')) ? (row.querySelector('.idem-store-custom')?.value || '') : '',
      ttl:           row.querySelector('.idem-ttl')?.value || '',
      duplicate:     row.querySelector('.idem-dup')?.value || '',
      duplicateCustom: !(row.querySelector('.idem-dup-custom')?.classList?.contains('hidden')) ? (row.querySelector('.idem-dup-custom')?.value || '') : '',
      retry:         row.querySelector('.idem-retry')?.value || '',
      retryCustom:   !(row.querySelector('.idem-retry-custom')?.classList?.contains('hidden')) ? (row.querySelector('.idem-retry-custom')?.value || '') : '',
      timeout:       row.querySelector('.idem-timeout')?.value || '',
      rateLimit:     row.querySelector('.idem-rl')?.value || ''
    } : null;

    const path   = (row.querySelector('.ep-path')?.value || '').trim();
    const method = row.querySelector('.ep-method')?.value || 'GET';

    const errors = Array.from(row.querySelectorAll('.errTable tbody tr')).map(er=>({
      code:    er.querySelector('.err-code')?.value || '',
      meaning: er.querySelector('.err-meaning')?.value || ''
    }));

    return {
      path,
      method,
      idempotent: (row.querySelector('.ep-idem')?.value || 'Yes') === 'Yes',
      idempotency: idem,
      errors
    };
  });

  // KEEP ONLY meaningful endpoints (must have a non-empty path)
  target.endpoints = mapped.filter(ep => ep.path.length > 0);
}
  });
})();
/* =========================
   STEP 3: Message Broker Integration
========================= */
(function(){
  const ACCEPT_SCHEMA = '.json,.yaml,.yml,.avsc';

  function platformSelectHTML(cls){
    return `
      <div>
        <div class="label">Platform</div>
        <select class="${cls} mb-platform">
          <option>RabbitMQ</option>
          <option>Kafka</option>
        </select>
      </div>`;
  }

  // Publisher — per-platform config
  function pubRabbitHTML(){
    return `
      <div class="row-2">
        <div><div class="label">Event</div><input class="mb-event" type="text" placeholder="e.g., claim.updated"/></div>
        <div><div class="label">Exchange</div><input class="mb-exchange" type="text" placeholder="exchange.name"/></div>
      </div>
      <div class="row-2">
        <div><div class="label">Routing Key</div><input class="mb-routing" type="text" placeholder="routing.key"/></div>
        <div><div class="label">Schema Version</div><input class="mb-schemaVer" type="text" placeholder="e.g., 1.0"/></div>
      </div>
      <div class="row-2">
        <div><div class="label">Use Case</div><input class="mb-usecase" type="text" placeholder="Internal service notification UC"/></div>
        <div>
          <div class="label">Payload Schema</div>
          <input class="mb-payload" type="file" accept="${ACCEPT_SCHEMA}"/>
        </div>
      </div>
      <div class="row-2" style="margin-top:10px">
        <div>
          <div class="label">Delivery Guarantee</div>
          <select class="mb-guarantee">
            <option>At-least-once</option>
            <option>Exactly-once</option>
          </select>
          <div class="expl">Rationale (consumer idempotent? transactional?):</div>
          <input class="mb-guar-rat" type="text" placeholder="Short rationale"/>
        </div>
        <div>
          <div class="label">Ordering Guarantee</div>
          <select class="mb-ordering"><option>Yes</option><option>No</option></select>
        </div>
      </div>`;
  }
  function pubKafkaHTML(){
    return `
      <div class="row-2">
        <div><div class="label">Topic</div><input class="mb-topic" type="text" placeholder="topic.name"/></div>
        <div><div class="label">Partition Key</div><input class="mb-partkey" type="text" placeholder="Field for partitioning"/></div>
      </div>
      <div class="row-3">
        <div><div class="label">Partitions</div><input class="mb-partitions" type="text" placeholder="e.g., 6"/></div>
        <div><div class="label">Replication Factor</div><input class="mb-repl" type="text" placeholder="e.g., 3"/></div>
        <div><div class="label">Retention Period</div><input class="mb-ret" type="text" placeholder="e.g., 7d"/></div>
      </div>
      <div class="row-2">
        <div><div class="label">Schema Version</div><input class="mb-schemaVer" type="text" placeholder="e.g., 1.0"/></div>
        <div><div class="label">Use Case</div><input class="mb-usecase" type="text" placeholder="Notify downstream state change"/></div>
      </div>
      <div class="row-2">
        <div>
          <div class="label">Payload Schema</div>
          <input class="mb-payload" type="file" accept="${ACCEPT_SCHEMA}"/>
        </div>
        <div>
          <div class="label">Producer Acks</div>
          <select class="mb-acks"><option>all</option><option>1</option><option>0</option></select>
        </div>
      </div>
      <div class="row-2" style="margin-top:10px">
        <div>
          <div class="label">Delivery Guarantee</div>
          <select class="mb-guarantee">
            <option>At-least-once</option>
            <option>Exactly-once</option>
          </select>
        </div>
        <div>
          <div class="label">Ordering Guarantee</div>
          <select class="mb-ordering"><option>Yes</option><option>No</option></select>
          <div class="expl">Kafka ordering is per partition key.</div>
        </div>
      </div>`;
  }

  // Consumer — per-platform config
  function conRabbitHTML(){
    return `
      <div class="row-2">
        <div><div class="label">Queue</div><input class="mc-queue" type="text" placeholder="queue.name"/></div>
        <div><div class="label">Binding Key</div><input class="mc-bind" type="text" placeholder="routing.key"/></div>
      </div>
      <div class="row-3">
        <div><div class="label">Exchange (optional)</div><input class="mc-exchange" type="text" placeholder="exchange.name"/></div>
        <div><div class="label">Prefetch</div><input class="mc-prefetch" type="text" placeholder="e.g., 50"/></div>
        <div>
          <div class="label">Ack Mode</div>
          <select class="mc-ack"><option>manual</option><option>auto</option></select>
        </div>
      </div>
      <div class="row-3">
        <div>
          <div class="label">Dead-letter (DLX)</div>
          <select class="mc-dlx"><option>No</option><option>Yes</option></select>
          <input class="mc-dlx-name hidden" type="text" placeholder="dlx.name"/>
        </div>
        <div><div class="label">Retry — Max Attempts</div><input class="mc-retry-max" type="text" placeholder="e.g., 5"/></div>
        <div><div class="label">Retry — Backoff</div><input class="mc-retry-backoff" type="text" placeholder="e.g., 2s exponential"/></div>
      </div>
      <div class="row-2">
        <div>
          <div class="label">Delivery Guarantee</div>
          <select class="mc-guarantee"><option>At-least-once</option><option>Exactly-once</option></select>
        </div>
        <div>
          <div class="label">Expected Payload Schema</div>
          <input class="mc-payload" type="file" accept="${ACCEPT_SCHEMA}"/>
        </div>
      </div>`;
  }
  function conKafkaHTML(){
    return `
      <div class="row-2">
        <div><div class="label">Topic</div><input class="kc-topic" type="text" placeholder="topic.name"/></div>
        <div><div class="label">Group ID</div><input class="kc-group" type="text" placeholder="consumer-group"/></div>
      </div>
      <div class="row-3">
        <div>
          <div class="label">Offset Reset</div>
          <select class="kc-reset"><option>latest</option><option>earliest</option></select>
        </div>
        <div><div class="label">Max Poll Records</div><input class="kc-maxpoll" type="text" placeholder="e.g., 500"/></div>
        <div><div class="label">Retry/Backoff</div><input class="kc-retry" type="text" placeholder="e.g., 3 attempts, exp backoff"/></div>
      </div>
      <div class="row-2">
        <div>
          <div class="label">Delivery Guarantee</div>
          <select class="kc-guarantee"><option>At-least-once</option><option>Exactly-once</option></select>
        </div>
        <div>
          <div class="label">Expected Payload Schema</div>
          <input class="kc-payload" type="file" accept="${ACCEPT_SCHEMA}"/>
        </div>
      </div>`;
  }

  // Helpers to add/remove cards
  function mkCard(remHandler, innerHTML){
    const card=document.createElement('div');
    card.className='block';
    card.innerHTML = innerHTML + `<div style="text-align:right;margin-top:8px"><button class="btn-mini btn-danger">✕ Remove</button></div>`;
    card.querySelector('.btn-mini.btn-danger').onclick=()=>remHandler(card);
    return card;
  }

  function addPublished(container, preset){
    const card = mkCard(el=>el.remove(), `
      <div class="row-2">
        ${platformSelectHTML('pub')}
        <div><div class="label">Name / Title</div><input class="mb-name" type="text" placeholder="Human-friendly name"/></div>
      </div>
      <div class="pub-body"></div>
    `);
    container.appendChild(card);

    const platSel = card.querySelector('.mb-platform');
    const body    = card.querySelector('.pub-body');

    function render(){
      body.innerHTML = platSel.value==='Kafka' ? pubKafkaHTML() : pubRabbitHTML();
      // attach DLX name toggle on Rabbit
      const dlxSel = body.querySelector('.mc-dlx');
      if(dlxSel){
        const nameEl = body.querySelector('.mc-dlx-name');
        dlxSel.addEventListener('change',()=> nameEl.classList.toggle('hidden', dlxSel.value!=='Yes'));
      }
      // hydrate preset file names
      if(preset?.payloadName){
        const f = body.querySelector('.mb-payload');
        if(f) f.setAttribute('data-display', preset.payloadName);
      }
    }
    platSel.addEventListener('change', render);
    render();

    // hydrate preset
    if(preset){
      platSel.value = preset.platform || 'RabbitMQ';
      platSel.dispatchEvent(new Event('change'));
      // Fill shared fields
      card.querySelector('.mb-name').value = preset.name || '';
      // Fill per-platform
      if(platSel.value==='RabbitMQ'){
        body.querySelector('.mb-event').value = preset.event || '';
        body.querySelector('.mb-exchange').value = preset.exchange || '';
        body.querySelector('.mb-routing').value = preset.routingKey || '';
        body.querySelector('.mb-schemaVer').value = preset.schemaVersion || '';
        body.querySelector('.mb-usecase').value = preset.useCase || '';
        if(preset.payloadName){ body.querySelector('.mb-payload')?.setAttribute('data-display', preset.payloadName); }
        body.querySelector('.mb-guarantee').value = preset.delivery || 'At-least-once';
        body.querySelector('.mb-guar-rat').value = preset.deliveryRationale || '';
        body.querySelector('.mb-ordering').value = preset.ordering || 'No';
      } else {
        body.querySelector('.mb-topic').value = preset.topic || '';
        body.querySelector('.mb-partkey').value = preset.partitionKey || '';
        body.querySelector('.mb-partitions').value = preset.partitions || '';
        body.querySelector('.mb-repl').value = preset.replication || '';
        body.querySelector('.mb-ret').value = preset.retention || '';
        body.querySelector('.mb-schemaVer').value = preset.schemaVersion || '';
        body.querySelector('.mb-usecase').value = preset.useCase || '';
        if(preset.payloadName){ body.querySelector('.mb-payload')?.setAttribute('data-display', preset.payloadName); }
        body.querySelector('.mb-acks').value = preset.acks || 'all';
        body.querySelector('.mb-guarantee').value = preset.delivery || 'At-least-once';
        body.querySelector('.mb-ordering').value = preset.ordering || 'Yes';
      }
    }
  }

  function addConsumed(container, preset){
    const card = mkCard(el=>el.remove(), `
      <div class="row-2">
        ${platformSelectHTML('con')}
        <div><div class="label">Name / Title</div><input class="mc-name" type="text" placeholder="Human-friendly name"/></div>
      </div>
      <div class="con-body"></div>
    `);
    container.appendChild(card);

    const platSel = card.querySelector('.mb-platform');
    const body    = card.querySelector('.con-body');

    function render(){
      body.innerHTML = platSel.value==='Kafka' ? conKafkaHTML() : conRabbitHTML();
      // Rabbit DLX toggle
      const dlxSel = body.querySelector('.mc-dlx');
      if(dlxSel){
        const nameEl = body.querySelector('.mc-dlx-name');
        dlxSel.addEventListener('change',()=> nameEl.classList.toggle('hidden', dlxSel.value!=='Yes'));
      }
      // hydrate preset filename
      if(preset?.payloadName){
        const f = body.querySelector('.mc-payload, .kc-payload');
        if(f) f.setAttribute('data-display', preset.payloadName);
      }
    }
    platSel.addEventListener('change', render);
    render();

    // hydrate preset
    if(preset){
      platSel.value = preset.platform || 'RabbitMQ';
      platSel.dispatchEvent(new Event('change'));
      card.querySelector('.mc-name').value = preset.name || '';
      if(platSel.value==='RabbitMQ'){
        body.querySelector('.mc-queue').value = preset.queue || '';
        body.querySelector('.mc-bind').value  = preset.bindingKey || '';
        body.querySelector('.mc-exchange').value = preset.exchange || '';
        body.querySelector('.mc-prefetch').value = preset.prefetch || '';
        body.querySelector('.mc-ack').value = preset.ack || 'manual';
        body.querySelector('.mc-dlx').value = preset.dlx || 'No';
        if(preset.dlx==='Yes'){ const n=body.querySelector('.mc-dlx-name'); n.classList.remove('hidden'); n.value = preset.dlxName || ''; }
        body.querySelector('.mc-retry-max').value = preset.retryMax || '';
        body.querySelector('.mc-retry-backoff').value = preset.retryBackoff || '';
        body.querySelector('.mc-guarantee').value = preset.delivery || 'At-least-once';
        if(preset.payloadName){ body.querySelector('.mc-payload')?.setAttribute('data-display', preset.payloadName); }
      } else {
        body.querySelector('.kc-topic').value = preset.topic || '';
        body.querySelector('.kc-group').value = preset.groupId || '';
        body.querySelector('.kc-reset').value = preset.reset || 'latest';
        body.querySelector('.kc-maxpoll').value = preset.maxPoll || '';
        body.querySelector('.kc-retry').value = preset.retry || '';
        body.querySelector('.kc-guarantee').value = preset.delivery || 'At-least-once';
        if(preset.payloadName){ body.querySelector('.kc-payload')?.setAttribute('data-display', preset.payloadName); }
      }
    }
  }

  registerStep({
    id:'msg_broker',
    title:'Message Broker Integration',
    mount(root, data, nav){
      const tpl=document.getElementById('tpl-step-3');
      root.appendChild(tpl.content.cloneNode(true));

      const pubWrap = root.querySelector('#pubWrap');
      const conWrap = root.querySelector('#conWrap');

      root.querySelector('#btnAddPub').onclick = ()=> addPublished(pubWrap);
      root.querySelector('#btnAddCon').onclick = ()=> addConsumed(conWrap);

      // hydrate from data
      const pubs = Array.isArray(data.published)? data.published : [];
      const cons = Array.isArray(data.consumed)?  data.consumed  : [];
      (pubs.length?pubs:[{}]).forEach(p=>addPublished(pubWrap, p));
      (cons.length?cons:[{}]).forEach(c=>addConsumed(conWrap, c));

      // hydrate rationale
      if(Array.isArray(data.rationale)){
        root.querySelectorAll('.mb-rat').forEach(cb=>{
          if(data.rationale.includes(cb.value)) cb.checked = true;
        });
      }
    },
    serialize(target, root){
      // rationale
      target.rationale = Array.from(root.querySelectorAll('.mb-rat:checked')).map(cb=>cb.value);

      // published
      target.published = Array.from(root.querySelectorAll('#pubWrap > .block')).map(card=>{
        const platform = card.querySelector('.mb-platform')?.value || 'RabbitMQ';
        const name     = card.querySelector('.mb-name')?.value || '';
        const body     = card.querySelector('.pub-body');

        if(platform==='Kafka'){
          return {
            platform, name,
            topic: body.querySelector('.mb-topic')?.value || '',
            partitionKey: body.querySelector('.mb-partkey')?.value || '',
            partitions: body.querySelector('.mb-partitions')?.value || '',
            replication: body.querySelector('.mb-repl')?.value || '',
            retention: body.querySelector('.mb-ret')?.value || '',
            schemaVersion: body.querySelector('.mb-schemaVer')?.value || '',
            useCase: body.querySelector('.mb-usecase')?.value || '',
            payloadName: body.querySelector('.mb-payload')?.files?.[0]?.name || (body.querySelector('.mb-payload')?.getAttribute('data-display')||''),
            acks: body.querySelector('.mb-acks')?.value || 'all',
            delivery: body.querySelector('.mb-guarantee')?.value || 'At-least-once',
            ordering: body.querySelector('.mb-ordering')?.value || 'Yes'
          };
        } else {
          return {
            platform, name,
            event: body.querySelector('.mb-event')?.value || '',
            exchange: body.querySelector('.mb-exchange')?.value || '',
            routingKey: body.querySelector('.mb-routing')?.value || '',
            schemaVersion: body.querySelector('.mb-schemaVer')?.value || '',
            useCase: body.querySelector('.mb-usecase')?.value || '',
            payloadName: body.querySelector('.mb-payload')?.files?.[0]?.name || (body.querySelector('.mb-payload')?.getAttribute('data-display')||''),
            delivery: body.querySelector('.mb-guarantee')?.value || 'At-least-once',
            deliveryRationale: body.querySelector('.mb-guar-rat')?.value || '',
            ordering: body.querySelector('.mb-ordering')?.value || 'No'
          };
        }
      });

      // consumed
      target.consumed = Array.from(root.querySelectorAll('#conWrap > .block')).map(card=>{
        const platform = card.querySelector('.mb-platform')?.value || 'RabbitMQ';
        const name     = card.querySelector('.mc-name')?.value || '';
        const body     = card.querySelector('.con-body');

        if(platform==='Kafka'){
          return {
            platform, name,
            topic: body.querySelector('.kc-topic')?.value || '',
            groupId: body.querySelector('.kc-group')?.value || '',
            reset: body.querySelector('.kc-reset')?.value || 'latest',
            maxPoll: body.querySelector('.kc-maxpoll')?.value || '',
            retry: body.querySelector('.kc-retry')?.value || '',
            delivery: body.querySelector('.kc-guarantee')?.value || 'At-least-once',
            payloadName: body.querySelector('.kc-payload')?.files?.[0]?.name || (body.querySelector('.kc-payload')?.getAttribute('data-display')||'')
          };
        } else {
          const dlx = body.querySelector('.mc-dlx')?.value || 'No';
          return {
            platform, name,
            queue: body.querySelector('.mc-queue')?.value || '',
            bindingKey: body.querySelector('.mc-bind')?.value || '',
            exchange: body.querySelector('.mc-exchange')?.value || '',
            prefetch: body.querySelector('.mc-prefetch')?.value || '',
            ack: body.querySelector('.mc-ack')?.value || 'manual',
            dlx,
            dlxName: (dlx==='Yes') ? (body.querySelector('.mc-dlx-name')?.value || '') : '',
            retryMax: body.querySelector('.mc-retry-max')?.value || '',
            retryBackoff: body.querySelector('.mc-retry-backoff')?.value || '',
            delivery: body.querySelector('.mc-guarantee')?.value || 'At-least-once',
            payloadName: body.querySelector('.mc-payload')?.files?.[0]?.name || (body.querySelector('.mc-payload')?.getAttribute('data-display')||'')
          };
        }
      });
    }
  });
})();
/* =========================
   STEP 4: Data Storage
========================= */
(function(){
  // Helpers
  function h(el, sel){ return el.querySelector(sel); }
  function addRetRow(tbody, preset={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="ret-name" placeholder="table/collection" value="${preset.name||''}"/></td>
      <td><input type="text" class="ret-period" placeholder="e.g., 7y / 30d" value="${preset.period||''}"/></td>
      <td>
        <select class="ret-strategy">
          <option ${preset.strategy==='soft'?'selected':''} value="soft">Soft delete</option>
          <option ${preset.strategy==='archive'?'selected':''} value="archive">Archive + delete</option>
          <option ${preset.strategy==='hard'?'selected':''} value="hard">Hard delete</option>
          <option ${preset.strategy==='ttl'?'selected':''} value="ttl">TTL (auto expire)</option>
        </select>
      </td>
      <td>
        <select class="ret-legal">
          <option ${preset.legal==='No'?'selected':''}>No</option>
          <option ${preset.legal==='Yes'?'selected':''}>Yes</option>
        </select>
      </td>
      <td><input type="text" class="ret-notes" placeholder="notes…" value="${preset.notes||''}"/></td>
      <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
    `;
    tbody.appendChild(tr);
  }

  function structFor(engine){
    if(engine==='MongoDB'){
      return `
        <div class="block">
          <div class="label">Indexes</div>
          <table class="ds-idx">
            <thead><tr><th>Collection</th><th>Keys (JSON)</th><th>Type</th><th>Unique?</th><th style="width:40px"></th></tr></thead>
            <tbody></tbody>
          </table>
          <button class="btn-mini ds-add-idx">+ Add index</button>
        </div>
        <div class="block" style="margin-top:10px">
          <div class="label">Sharding</div>
          <div class="row-3">
            <div><input type="text" class="ds-shard-key" placeholder="Shard key (e.g., { policyId: 1 })"/></div>
            <div>
              <select class="ds-shard-strategy">
                <option>hashed</option><option>ranged</option>
              </select>
            </div>
            <div>
              <select class="ds-shard-presplit">
                <option>No</option><option>Yes</option>
              </select>
            </div>
          </div>
        </div>
      `;
    } else {
      // Postgres / MSSQL
      return `
        <div class="block">
          <div class="label">Indexes</div>
          <table class="ds-idx">
            <thead><tr><th>Table</th><th>Columns</th><th>Type</th><th>Unique?</th><th style="width:40px"></th></tr></thead>
            <tbody></tbody>
          </table>
          <button class="btn-mini ds-add-idx">+ Add index</button>
        </div>
        <div class="block" style="margin-top:10px">
          <div class="label">Partitioning</div>
          <div class="row-3">
            <div>
              <select class="ds-part-strategy">
                <option>none</option><option>range</option><option>list</option><option>hash</option>
              </select>
            </div>
            <div><input type="text" class="ds-part-key" placeholder="Partition key (e.g., claim_date)"/></div>
            <div><input type="text" class="ds-part-notes" placeholder="Notes"/></div>
          </div>
        </div>
      `;
    }
  }

  function addIdxRow(tbody, engine, preset={}){
    const tr = document.createElement('tr');
    if(engine==='MongoDB'){
      tr.innerHTML = `
        <td><input type="text" class="idx-coll" placeholder="collection" value="${preset.collection||''}"/></td>
        <td><input type="text" class="idx-keys" placeholder='{"field": 1, "other": -1}' value="${preset.keys||''}"/></td>
        <td>
          <select class="idx-type">
            <option ${preset.type==='single'?'selected':''} value="single">single</option>
            <option ${preset.type==='compound'?'selected':''} value="compound">compound</option>
            <option ${preset.type==='ttl'?'selected':''} value="ttl">ttl</option>
            <option ${preset.type==='text'?'selected':''} value="text">text</option>
          </select>
        </td>
        <td>
          <select class="idx-uniq">
            <option ${preset.unique==='No'?'selected':''}>No</option>
            <option ${preset.unique==='Yes'?'selected':''}>Yes</option>
          </select>
        </td>
        <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
      `;
    } else {
      tr.innerHTML = `
        <td><input type="text" class="idx-table" placeholder="table" value="${preset.table||''}"/></td>
        <td><input type="text" class="idx-cols" placeholder="col1, col2" value="${preset.columns||''}"/></td>
        <td>
          <select class="idx-type">
            <option ${preset.type==='btree'?'selected':''} value="btree">btree</option>
            <option ${preset.type==='gin'?'selected':''} value="gin">gin</option>
            <option ${preset.type==='hash'?'selected':''} value="hash">hash</option>
          </select>
        </td>
        <td>
          <select class="idx-uniq">
            <option ${preset.unique==='No'?'selected':''}>No</option>
            <option ${preset.unique==='Yes'?'selected':''}>Yes</option>
          </select>
        </td>
        <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
      `;
    }
    tbody.appendChild(tr);
  }

  registerStep({
    id:'data_storage',
    title:'Data Storage',
    mount(root, data, nav){
      const tpl = document.getElementById('tpl-step-4');
      root.appendChild(tpl.content.cloneNode(true));

      const engSel = root.querySelector('#ds-dbEngine');
      const srcSel = root.querySelector('#ds-schemaSource');
      const uploadWrap = root.querySelector('#ds-uploadWrap');
      const inlineWrap = root.querySelector('#ds-inlineWrap');
      const schemaFile = root.querySelector('#ds-schemaFile');
      const structWrap = root.querySelector('#ds-structWrap');

      // hydrate simple fields
      root.querySelectorAll('[data-k]').forEach(el=>{
        const k=el.getAttribute('data-k');
        if(data[k]!=null) el.value=data[k];
      });

      // db engine affects file accept + struct panel
      function refreshAccept(){
        const eng = engSel.value;
        if(eng==='MongoDB'){
          schemaFile.setAttribute('accept','.json,.yaml,.yml');
        } else {
          schemaFile.setAttribute('accept','.sql');
        }
        structWrap.innerHTML = structFor(eng);

        // indexing add button
        const idxTb = structWrap.querySelector('.ds-idx tbody');
        const addIdx = structWrap.querySelector('.ds-add-idx');
        addIdx.onclick = ()=> addIdxRow(idxTb, eng);

        // hydrate previously saved structure
        if(data.struct){
          const s=data.struct;
          if(Array.isArray(s.indexes) && s.indexes.length){
            s.indexes.forEach(ix=>addIdxRow(idxTb, eng, ix));
          }else{
            addIdxRow(idxTb, eng);
          }
          if(eng==='MongoDB'){
            if(s.sharding){
              structWrap.querySelector('.ds-shard-key').value = s.sharding.key || '';
              structWrap.querySelector('.ds-shard-strategy').value = s.sharding.strategy || 'hashed';
              structWrap.querySelector('.ds-shard-presplit').value = s.sharding.preSplit || 'No';
            }
          }else{
            if(s.partitioning){
              structWrap.querySelector('.ds-part-strategy').value = s.partitioning.strategy || 'none';
              structWrap.querySelector('.ds-part-key').value = s.partitioning.key || '';
              structWrap.querySelector('.ds-part-notes').value = s.partitioning.notes || '';
            }
          }
        } else {
          // fresh page gets one index row
          addIdxRow(idxTb, eng);
        }
      }
      engSel.addEventListener('change', refreshAccept);

      // schema source toggle
      function refreshSchemaSrc(){
        const v = srcSel.value;
        uploadWrap.classList.toggle('hidden', v!=='Upload file');
        inlineWrap.classList.toggle('hidden', v!=='Inline editor');
      }
      srcSel.addEventListener('change', refreshSchemaSrc);

      // retention table
      const retTb = root.querySelector('#ds-retTable tbody');
      root.querySelector('#ds-addRet').onclick = ()=> addRetRow(retTb);

      // hydrate from data
      engSel.value = data.dbEngine || 'Postgres';
      srcSel.value = data.schemaSource || 'Upload file';
      refreshAccept();
      refreshSchemaSrc();

      if(data.schemaFileName){
        schemaFile.setAttribute('data-display', data.schemaFileName);
      }
      if(data.schemaInline){
        root.querySelector('#ds-schemaInline').value = data.schemaInline;
      }

      const rets = Array.isArray(data.retention)? data.retention : [];
      if(rets.length){ rets.forEach(r=>addRetRow(retTb, r)); } else { addRetRow(retTb); }

      // TLS custom
      const encTransitSel = root.querySelector('[data-k="encTransit"]');
      const transitCustom = root.querySelector('#ds-transitCustom');
      function toggleTls(){ transitCustom.classList.toggle('hidden', encTransitSel.value!=='Custom'); }
      encTransitSel.addEventListener('change', toggleTls);
      toggleTls();
    },
    serialize(target, root){
      // basic fields
      root.querySelectorAll('[data-k]').forEach(el=>{
        const k=el.getAttribute('data-k'); target[k]=el.value||'';
      });

      // engine & schema source
      const eng = root.querySelector('#ds-dbEngine')?.value || 'Postgres';
      const src = root.querySelector('#ds-schemaSource')?.value || 'Upload file';
      target.dbEngine = eng;
      target.schemaSource = src;

      // schema
      const fileEl = root.querySelector('#ds-schemaFile');
      if(fileEl && fileEl.files && fileEl.files[0]){
        target.schemaFileName = fileEl.files[0].name;
      }else{
        // persist displayed filename if previously set
        const disp = fileEl?.getAttribute('data-display');
        if(disp) target.schemaFileName = disp;
      }
      target.schemaInline = (root.querySelector('#ds-schemaInline')?.value || '');

      // retention (filter empties)
      const rows = Array.from(root.querySelectorAll('#ds-retTable tbody tr'));
      target.retention = rows.map(tr=>({
        name:   tr.querySelector('.ret-name')?.value.trim() || '',
        period: tr.querySelector('.ret-period')?.value.trim() || '',
        strategy: tr.querySelector('.ret-strategy')?.value || 'soft',
        legal:  tr.querySelector('.ret-legal')?.value || 'No',
        notes:  tr.querySelector('.ret-notes')?.value || ''
      })).filter(r=>r.name.length>0);

      // structure
      const struct = {};
      const engIsMongo = eng==='MongoDB';
      const idxRows = Array.from(root.querySelectorAll('.ds-idx tbody tr'));
      struct.indexes = idxRows.map(tr=>{
        if(engIsMongo){
          return {
            collection: tr.querySelector('.idx-coll')?.value || '',
            keys: tr.querySelector('.idx-keys')?.value || '',
            type: tr.querySelector('.idx-type')?.value || 'single',
            unique: tr.querySelector('.idx-uniq')?.value || 'No'
          };
        } else {
          return {
            table: tr.querySelector('.idx-table')?.value || '',
            columns: tr.querySelector('.idx-cols')?.value || '',
            type: tr.querySelector('.idx-type')?.value || 'btree',
            unique: tr.querySelector('.idx-uniq')?.value || 'No'
          };
        }
      }).filter(ix => (engIsMongo ? (ix.collection||'').trim().length>0 : (ix.table||'').trim().length>0));

      if(engIsMongo){
        struct.sharding = {
          key: root.querySelector('.ds-shard-key')?.value || '',
          strategy: root.querySelector('.ds-shard-strategy')?.value || 'hashed',
          preSplit: root.querySelector('.ds-shard-presplit')?.value || 'No'
        };
      } else {
        struct.partitioning = {
          strategy: root.querySelector('.ds-part-strategy')?.value || 'none',
          key: root.querySelector('.ds-part-key')?.value || '',
          notes: root.querySelector('.ds-part-notes')?.value || ''
        };
      }
      target.struct = struct;
    }
  });
})();
/* =========================
   STEP 5: Caching Layer
========================= */
(function(){
  function q(r, s){ return r.querySelector(s); }
  function show(el, on){ el.classList.toggle('hidden', !on); }

  registerStep({
    id:'cache_layer',
    title:'Caching Layer',
    mount(root, data){
      const tpl = document.getElementById('tpl-step-5');
      root.appendChild(tpl.content.cloneNode(true));

      const engSel = q(root,'#cl-engine');
      const usageSel = q(root,'#cl-usage');
      const usageCustom = q(root,'#cl-usage-custom');

      const evRedis = q(root,'#cl-evict-redis');
      const evMemc  = q(root,'#cl-evict-memc');
      const redisOnly = q(root,'#cl-redis-only');

      // hydrate simple text/selects from data
      const map = {
        '#cl-engine':'engine','#cl-usage':'usage','#cl-topology':'topology','#cl-size':'size','#cl-qps':'qps',
        '#cl-keyns':'keyns','#cl-ser':'serialization','#cl-ttl':'ttl','#cl-ttl-over':'ttlOverrides',
        '#cl-compress':'compress','#cl-evict':'evict','#cl-maxmem':'maxmem',
        '#cl-evict-m':'evictMemc','#cl-memc-mem':'memcMem',
        '#cl-inv':'invalidate','#cl-warm':'warmup',
        '#cl-persist':'persist','#cl-rep':'replication','#cl-hashtag':'hashtag',
        '#cl-auth':'auth','#cl-tls':'tls','#cl-metrics':'metrics'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root, sel);
        if(!el) return;
        if(data[key]!=null) el.value = data[key];
      });
      if(data.usageCustom){ usageCustom.value = data.usageCustom; }

      // engine switches
      function applyEngine(){
        const e = engSel.value;
        const isRedis = e==='Redis';
        show(evRedis, isRedis);
        show(redisOnly, isRedis);
        show(evMemc, !isRedis);
      }
      engSel.addEventListener('change', applyEngine);
      applyEngine();

      // custom usage toggle
      function applyUsage(){
        const v = usageSel.value;
        show(usageCustom, v==='Other');
      }
      usageSel.addEventListener('change', applyUsage);
      applyUsage();

      // custom invalidation
      const invSel = q(root,'#cl-inv');
      const invCustom = q(root,'#cl-inv-custom');
      function applyInv(){ show(invCustom, invSel.value==='Custom'); }
      invSel.addEventListener('change', applyInv);
      applyInv();

      // custom auth
      const authSel = q(root,'#cl-auth');
      const authCustom = q(root,'#cl-auth-custom');
      function applyAuth(){ show(authCustom, authSel.value==='Custom'); }
      authSel.addEventListener('change', applyAuth);
      applyAuth();
    },
    serialize(target, root){
      function val(sel){ return (q(root,sel)?.value ?? '').trim(); }
      target.engine       = val('#cl-engine');
      target.usage        = val('#cl-usage');
      target.usageCustom  = val('#cl-usage-custom');
      target.topology     = val('#cl-topology');
      target.size         = val('#cl-size');
      target.qps          = val('#cl-qps');

      target.keyns        = val('#cl-keyns');
      target.serialization= val('#cl-ser');
      target.ttl          = val('#cl-ttl');
      target.ttlOverrides = val('#cl-ttl-over');
      target.compress     = val('#cl-compress');

      if(target.engine==='Redis'){
        target.evict     = val('#cl-evict');
        target.maxmem    = val('#cl-maxmem');
        target.persist   = val('#cl-persist');
        target.replication = val('#cl-rep');
        target.hashtag   = val('#cl-hashtag');
        // clear memcached-only fields
        target.evictMemc = ''; target.memcMem = '';
      }else{
        target.evictMemc = val('#cl-evict-m');
        target.memcMem   = val('#cl-memc-mem');
        // clear redis-only fields
        target.evict=''; target.maxmem=''; target.persist=''; target.replication=''; target.hashtag='';
      }

      target.invalidate   = val('#cl-inv');
      target.invCustom    = val('#cl-inv-custom');
      target.warmup       = val('#cl-warm');

      target.auth         = val('#cl-auth');
      target.authCustom   = val('#cl-auth-custom');
      target.tls          = val('#cl-tls');
      target.metrics      = val('#cl-metrics');
    }
  });
})();
/* =========================
   STEP 6: Security
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function show(el,on){ if(el) el.classList.toggle('hidden', !on); }
  function addRow(tbody, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tbody.appendChild(tr); }

  registerStep({
    id:'security',
    title:'Security',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-6');
      root.appendChild(tpl.content.cloneNode(true));

      // --- AuthN toggles
      const mSel = q(root,'#sec-auth-method'), mCustom = q(root,'#sec-auth-method-custom');
      const vSel = q(root,'#sec-auth-validate'), vCustom = q(root,'#sec-auth-validate-custom');
      function applyAuth(){ show(mCustom, mSel.value==='Other'); show(vCustom, vSel.value==='Other'); }
      mSel.addEventListener('change', applyAuth); vSel.addEventListener('change', applyAuth);

      // scopes
      const scopesTb = q(root,'#sec-auth-scopes tbody');
      function addScopeRow(p={}){ addRow(scopesTb,
        `<td><input type="text" value="${p.scope||''}" placeholder="scope"/></td>
         <td><input type="text" value="${p.desc||''}" placeholder="optional description"/></td>
         <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`); }
      q(root,'#sec-add-scope').onclick=()=>addScopeRow();

      // --- AuthZ toggles
      const modelSel = q(root,'#sec-authz-model'), modelCustom = q(root,'#sec-authz-model-custom');
      const engSel   = q(root,'#sec-authz-engine'), engCustom = q(root,'#sec-authz-engine-custom');
      const enfSel   = q(root,'#sec-authz-enforce'), enfCustom = q(root,'#sec-authz-enforce-custom');
      function applyAuthZ(){
        show(modelCustom, modelSel.value==='Custom');
        show(engCustom, engSel.value==='Other');
        show(enfCustom, enfSel.value==='Custom');
      }
      modelSel.addEventListener('change', applyAuthZ);
      engSel.addEventListener('change', applyAuthZ);
      enfSel.addEventListener('change', applyAuthZ);

      const permTb = q(root,'#sec-authz-matrix tbody');
      function addPermRow(p={}){ addRow(permTb,
        `<td><input type="text" value="${p.role||''}" placeholder="role"/></td>
         <td><input type="text" value="${p.res||''}" placeholder="resource"/></td>
         <td><input type="text" value="${p.act||''}" placeholder="action"/></td>
         <td><input type="text" value="${p.cond||''}" placeholder="condition (optional)"/></td>
         <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`); }
      q(root,'#sec-add-perm').onclick=()=>addPermRow();

      // audit toggle
      const dstSel = q(root,'#sec-audit-dst'), dstCustom = q(root,'#sec-audit-dst-custom');
      function applyAudit(){ show(dstCustom, dstSel.value==='Other'); }
      dstSel.addEventListener('change', applyAudit);

      // PII table
      const piiTb = q(root,'#sec-pii tbody');
      function addPiiRow(p={}){ addRow(piiTb,
        `<td><input type="text" value="${p.field||''}" placeholder="e.g., nationalId"/></td>
         <td><input type="text" value="${p.who||''}" placeholder="who can access"/></td>
         <td><input type="text" value="${p.how||''}" placeholder="how restricted"/></td>
         <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`); }
      q(root,'#sec-add-pii').onclick=()=>addPiiRow();

      // Masking table
      const maskTb = q(root,'#sec-mask tbody');
      function maskSelect(val){
        const opts = ['full','last4','hash','redact','tokenize','custom']
          .map(o=>`<option ${val===o?'selected':''}>${o}</option>`).join('');
        return `<select class="mask-kind">${opts}</select>`;
      }
      function addMaskRow(p={}){ addRow(maskTb,
        `<td><input type="text" class="mask-field" value="${p.field||''}" placeholder="field name"/></td>
         <td>${maskSelect(p.kind)} <input class="mask-custom hidden" type="text" placeholder="describe custom"/></td>
         <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>`); }
      q(root,'#sec-add-mask').onclick=()=>addMaskRow();

      // hydrate data ->
      // simple fields
      const map = {
        '#sec-auth-exp':'authExp',
        '#sec-audit-ret':'auditRet',
        '#sec-audit-fields':'auditFields'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root,sel); if(el && data[key]!=null) el.value=data[key];
      });

      // selects + customs
      if(data.authMethod) mSel.value=data.authMethod;
      if(data.authMethodCustom) mCustom.value=data.authMethodCustom;
      if(data.authValidate) vSel.value=data.authValidate;
      if(data.authValidateCustom) vCustom.value=data.authValidateCustom;

      if(data.authzModel) modelSel.value=data.authzModel;
      if(data.authzModelCustom) modelCustom.value=data.authzModelCustom;
      if(data.authzEngine) engSel.value=data.authzEngine;
      if(data.authzEngineCustom) engCustom.value=data.authzEngineCustom;
      if(data.authzEnforce) enfSel.value=data.authzEnforce;
      if(data.authzEnforceCustom) enfCustom.value=data.authzEnforceCustom;

      if(data.auditScope) q(root,'#sec-audit-scope').value=data.auditScope;
      if(data.auditDst)   dstSel.value=data.auditDst;
      if(data.auditDstCustom) dstCustom.value=data.auditDstCustom;

      // lists
      const scopes = Array.isArray(data.scopes)?data.scopes:[];
      (scopes.length?scopes:[{}]).forEach(addScopeRow);

      const perms = Array.isArray(data.permissions)?data.permissions:[];
      (perms.length?perms:[{}]).forEach(addPermRow);

      const pii = Array.isArray(data.pii)?data.pii:[];
      (pii.length?pii:[{}]).forEach(addPiiRow);

      const masks = Array.isArray(data.masking)?data.masking:[];
      (masks.length?masks:[{}]).forEach(addMaskRow);

      // apply initial toggles
      applyAuth(); applyAuthZ(); applyAudit();

      // wire mask custom toggle
      root.addEventListener('change', (e)=>{
        const sel = e.target.closest('.mask-kind');
        if(!sel) return;
        const custom = sel.parentElement.querySelector('.mask-custom');
        show(custom, sel.value==='custom');
      });
      // show customs on hydrate
      root.querySelectorAll('.mask-kind').forEach(sel=>{
        const custom = sel.parentElement.querySelector('.mask-custom');
        show(custom, sel.value==='custom');
      });
      show(mCustom, mSel.value==='Other');
      show(vCustom, vSel.value==='Other');
      show(modelCustom, modelSel.value==='Custom');
      show(engCustom, engSel.value==='Other');
      show(enfCustom, enfSel.value==='Custom');
      show(dstCustom, dstSel.value==='Other');
    },
    serialize(target, root){
      function val(sel){ return (q(root,sel)?.value ?? '').trim(); }

      // AuthN
      target.authMethod = val('#sec-auth-method');
      target.authMethodCustom = val('#sec-auth-method-custom');
      target.authValidate = val('#sec-auth-validate');
      target.authValidateCustom = val('#sec-auth-validate-custom');
      target.authExp = val('#sec-auth-exp');
      target.scopes = Array.from(root.querySelectorAll('#sec-auth-scopes tbody tr')).map(tr=>({
        scope: tr.children[0].querySelector('input')?.value || '',
        desc:  tr.children[1].querySelector('input')?.value || ''
      })).filter(x=>x.scope.trim().length>0);

      // AuthZ
      target.authzModel = val('#sec-authz-model');
      target.authzModelCustom = val('#sec-authz-model-custom');
      target.authzEngine = val('#sec-authz-engine');
      target.authzEngineCustom = val('#sec-authz-engine-custom');
      target.authzEnforce = val('#sec-authz-enforce');
      target.authzEnforceCustom = val('#sec-authz-enforce-custom');
      target.permissions = Array.from(root.querySelectorAll('#sec-authz-matrix tbody tr')).map(tr=>({
        role: tr.children[0].querySelector('input')?.value || '',
        res:  tr.children[1].querySelector('input')?.value || '',
        act:  tr.children[2].querySelector('input')?.value || '',
        cond: tr.children[3].querySelector('input')?.value || ''
      })).filter(p=>p.role.trim().length&&p.res.trim().length&&p.act.trim().length);

      // Audit
      target.auditScope = val('#sec-audit-scope');
      target.auditRet   = val('#sec-audit-ret');
      target.auditDst   = val('#sec-audit-dst');
      target.auditDstCustom = val('#sec-audit-dst-custom');
      target.auditFields = val('#sec-audit-fields');

      // Data Protection
      target.pii = Array.from(root.querySelectorAll('#sec-pii tbody tr')).map(tr=>({
        field: tr.children[0].querySelector('input')?.value || '',
        who:   tr.children[1].querySelector('input')?.value || '',
        how:   tr.children[2].querySelector('input')?.value || ''
      })).filter(r=>r.field.trim().length>0);

      target.masking = Array.from(root.querySelectorAll('#sec-mask tbody tr')).map(tr=>{
        const field = tr.querySelector('.mask-field')?.value || '';
        const kind  = tr.querySelector('.mask-kind')?.value || 'full';
        const custom= tr.querySelector('.mask-custom')?.value || '';
        return { field, kind, custom };
      }).filter(r=>r.field.trim().length>0);
    }
  });
})();
/* =========================
   STEP 7: Observability
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function addRow(tb, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tb.appendChild(tr); }

  registerStep({
    id:'observability',
    title:'Observability',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-7');
      root.appendChild(tpl.content.cloneNode(true));

      // toggles
      const sinkSel = q(root,'#ob-log-sink'), sinkCustom = q(root,'#ob-log-sink-custom');
      sinkSel.addEventListener('change', ()=> sinkCustom.classList.toggle('hidden', sinkSel.value!=='Other'));

      const trSel = q(root,'#ob-tracing'), trCustom = q(root,'#ob-tracing-custom');
      trSel.addEventListener('change', ()=> trCustom.classList.toggle('hidden', trSel.value!=='Other'));

      // tables
      const mTb = q(root,'#ob-metrics tbody');
      const dTb = q(root,'#ob-dash tbody');
      const aTb = q(root,'#ob-alerts tbody');
      const lTb = q(root,'#ob-logs tbody');

      function metricRow(p={}){
        addRow(mTb, `
          <td><input type="text" value="${p.metric||''}" placeholder="e.g., p95_latency"/></td>
          <td>
            <select>
              <option ${p.type==='counter'?'selected':''}>counter</option>
              <option ${p.type==='gauge'?'selected':''}>gauge</option>
              <option ${p.type==='histogram'?'selected':''}>histogram</option>
              <option ${p.type==='summary'?'selected':''}>summary</option>
            </select>
          </td>
          <td><input type="text" value="${p.slo||''}" placeholder="Target/SLO"/></td>
          <td><input type="text" value="${p.collect||''}" placeholder="agent/lib (e.g., OTEL SDK)"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function dashRow(p={}){
        addRow(dTb, `
          <td><input type="text" value="${p.name||''}" placeholder="Dashboard name"/></td>
          <td><input type="text" value="${p.sys||''}" placeholder="Grafana/DataDog/Cloud"/></td>
          <td><input type="text" value="${p.link||''}" placeholder="Link or ID"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function alertRow(p={}){
        addRow(aTb, `
          <td>
            <select>
              <option ${p.sev==='Critical'?'selected':''}>Critical</option>
              <option ${p.sev==='High'?'selected':''}>High</option>
              <option ${p.sev==='Medium'?'selected':''}>Medium</option>
              <option ${p.sev==='Low'?'selected':''}>Low</option>
            </select>
          </td>
          <td><input type="text" value="${p.cond||''}" placeholder="Condition / threshold"/></td>
          <td><input type="text" value="${p.chan||''}" placeholder="Slack/Email/PagerDuty"/></td>
          <td><input type="text" value="${p.runbook||''}" placeholder="Runbook link or notes"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function logRow(p={}){
        const types = ['API request/response','DB query','External call','Cache op','AuthN/AuthZ','Background job','Error/Exception','Custom'];
        addRow(lTb, `
          <td>
            <select class="log-type">
              ${types.map(t=>`<option ${p.type===t?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="log-what" value="${p.what||''}" placeholder="What we log (e.g., duration, status code, sanitized)"/></td>
          <td>
            <select class="log-level">
              <option ${p.level==='ERROR'?'selected':''}>ERROR</option>
              <option ${p.level==='WARN'?'selected':''}>WARN</option>
              <option ${p.level==='INFO'?'selected':''}>INFO</option>
              <option ${p.level==='DEBUG'?'selected':''}>DEBUG</option>
              <option ${p.level==='TRACE'?'selected':''}>TRACE</option>
            </select>
          </td>
          <td>
            <select class="log-pii">
              <option ${p.pii==='Yes'?'selected':''}>Yes</option>
              <option ${p.pii==='No'?'selected':''}>No</option>
            </select>
          </td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }

      // add buttons
      q(root,'#ob-add-metric').onclick = ()=>metricRow();
      q(root,'#ob-add-dash').onclick   = ()=>dashRow();
      q(root,'#ob-add-alert').onclick  = ()=>alertRow();
      q(root,'#ob-add-log').onclick    = ()=>logRow();

      // hydrate simple fields
      const map = {
        '#ob-log-prod':'logProd','#ob-log-stg':'logStg','#ob-log-dev':'logDev',
        '#ob-log-sink':'logSink','#ob-tracing':'tracing','#ob-sampling':'sampling','#ob-prop':'propagation'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root, sel); if(el && data[key]!=null) el.value=data[key];
      });
      if(data.logSinkCustom){ q(root,'#ob-log-sink-custom').value=data.logSinkCustom; }
      if(data.tracingCustom){ q(root,'#ob-tracing-custom').value=data.tracingCustom; }

      // hydrate tables
      const mets = Array.isArray(data.metrics)?data.metrics:[]; (mets.length?mets:[{}]).forEach(metricRow);
      const dshs = Array.isArray(data.dashboards)?data.dashboards:[]; (dshs.length?dshs:[{}]).forEach(dashRow);
      const alts = Array.isArray(data.alerts)?data.alerts:[]; (alts.length?alts:[{}]).forEach(alertRow);
      const logs = Array.isArray(data.keyLogs)?data.keyLogs:[]; (logs.length?logs:[{}]).forEach(logRow);

      // show custom fields
      sinkCustom.classList.toggle('hidden', (q(root,'#ob-log-sink').value!=='Other'));
      trCustom.classList.toggle('hidden', (q(root,'#ob-tracing').value!=='Other'));
    },
    serialize(target, root){
      function val(sel){ return (q(root,sel)?.value ?? '').trim(); }

      // logging
      target.logProd = val('#ob-log-prod');
      target.logStg  = val('#ob-log-stg');
      target.logDev  = val('#ob-log-dev');
      target.logSink = val('#ob-log-sink');
      target.logSinkCustom = val('#ob-log-sink-custom');

      // metrics
      target.metrics = Array.from(root.querySelectorAll('#ob-metrics tbody tr')).map(tr=>({
        metric: tr.children[0].querySelector('input')?.value || '',
        type:   tr.children[1].querySelector('select')?.value || 'counter',
        slo:    tr.children[2].querySelector('input')?.value || '',
        collect:tr.children[3].querySelector('input')?.value || ''
      })).filter(m=>m.metric.trim().length>0);

      // tracing
      target.tracing = val('#ob-tracing');
      target.tracingCustom = val('#ob-tracing-custom');
      target.sampling = val('#ob-sampling');
      target.propagation = val('#ob-prop');

      // dashboards
      target.dashboards = Array.from(root.querySelectorAll('#ob-dash tbody tr')).map(tr=>({
        name: tr.children[0].querySelector('input')?.value || '',
        sys:  tr.children[1].querySelector('input')?.value || '',
        link: tr.children[2].querySelector('input')?.value || ''
      })).filter(d=>d.name.trim().length>0);

      // alerts
      target.alerts = Array.from(root.querySelectorAll('#ob-alerts tbody tr')).map(tr=>({
        sev:   tr.children[0].querySelector('select')?.value || 'High',
        cond:  tr.children[1].querySelector('input')?.value || '',
        chan:  tr.children[2].querySelector('input')?.value || '',
        runbook: tr.children[3].querySelector('input')?.value || ''
      })).filter(a=>a.cond.trim().length>0);

      // key log events
      target.keyLogs = Array.from(root.querySelectorAll('#ob-logs tbody tr')).map(tr=>{
        return {
          type:  tr.children[0].querySelector('select')?.value || 'API request/response',
          what:  tr.children[1].querySelector('input')?.value || '',
          level: tr.children[2].querySelector('select')?.value || 'INFO',
          pii:   tr.children[3].querySelector('select')?.value || 'No'
        };
      }).filter(k=>k.what.trim().length>0);
    }
  });
})();
/* =========================
   STEP 8: Performance & Scalability
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function addRow(tb, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tb.appendChild(tr); }
  function show(el,on){ if(el) el.classList.toggle('hidden', !on); }

  registerStep({
    id:'perf_scalability',
    title:'Performance & Scalability',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-8');
      root.appendChild(tpl.content.cloneNode(true));

      // pools table
      const pTb = q(root,'#ps-pools tbody');
      function poolRow(p={}){
        addRow(pTb, `
          <td>
            <select class="ps-p-comp">
              ${['Database','HTTP outbound','Message broker','Cache','File store','Custom']
                .map(o=>`<option ${p.comp===o?'selected':''}>${o}</option>`).join('')}
            </select>
            <input class="ps-p-comp-custom hidden" type="text" placeholder="Describe custom component"/>
          </td>
          <td><input type="text" class="ps-p-max" value="${p.max||''}" placeholder="e.g., 50"/></td>
          <td><input type="text" class="ps-p-to"  value="${p.to||''}"  placeholder="e.g., 3000"/></td>
          <td><input type="text" class="ps-p-notes" value="${p.notes||''}" placeholder="notes"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      q(root,'#ps-add-pool').onclick=()=>poolRow();

      // hydrate simple fields
      const map = {
        '#ps-cpu':'cpu','#ps-mem':'mem','#ps-warm':'warm',
        '#ps-minrep':'minRep','#ps-maxrep':'maxRep',
        '#ps-hpa-metric':'hpaMetric','#ps-hpa-target':'hpaTarget',
        '#ps-rl-policy':'rlPolicy','#ps-rl-limit':'rlLimit','#ps-rl-scope':'rlScope',
        '#ps-bp':'bp','#ps-bp-th':'bpTh','#ps-bp-fail':'bpFail',
        '#ob-log-prod':'logProd','#ob-log-stg':'logStg','#ob-log-dev':'logDev' // (not used here but harmless if present)
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root,sel); if(el && data[key]!=null) el.value=data[key];
      });

      // env targets
      function setEnv(row,pfx){
        if(!row||!data[pfx]) return;
        row.querySelector(`.ps-${pfx}-rps`)?.setAttribute('value', data[pfx].rps||'');
      }
      // hydrate env cells (directly by querying)
      const envMap = [
        ['prod','ps-prod-rps','ps-prod-p95','ps-prod-p99','ps-prod-err','ps-prod-slo'],
        ['stg','ps-stg-rps','ps-stg-p95','ps-stg-p99','ps-stg-err','ps-stg-slo'],
        ['dev','ps-dev-rps','ps-dev-p95','ps-dev-p99','ps-dev-err','ps-dev-slo']
      ];
      if(data.env){
        const v=data.env;
        const set = (cls,val)=>{ const el=q(root, `.${cls}`); if(el) el.value = val ?? ''; };
        set('ps-prod-rps', v.prod?.rps); set('ps-prod-p95', v.prod?.p95); set('ps-prod-p99', v.prod?.p99);
        set('ps-prod-err', v.prod?.err); set('ps-prod-slo', v.prod?.slo);

        set('ps-stg-rps', v.stg?.rps); set('ps-stg-p95', v.stg?.p95); set('ps-stg-p99', v.stg?.p99);
        set('ps-stg-err', v.stg?.err); set('ps-stg-slo', v.stg?.slo);

        set('ps-dev-rps', v.dev?.rps); set('ps-dev-p95', v.dev?.p95); set('ps-dev-p99', v.dev?.p99);
        set('ps-dev-err', v.dev?.err); set('ps-dev-slo', v.dev?.slo);
      }

      // HPA custom metric toggle
      const metricSel = q(root,'#ps-hpa-metric'), metricCustom = q(root,'#ps-hpa-custom');
      function applyMetric(){ show(metricCustom, metricSel.value==='Custom (Prometheus/OTEL)'); }
      metricSel.addEventListener('change', applyMetric); applyMetric();

      // Rate limiting custom toggle
      const rlSel = q(root,'#ps-rl-policy'), rlCustom = q(root,'#ps-rl-policy-custom');
      function applyRl(){ show(rlCustom, rlSel.value==='Other'); }
      rlSel.addEventListener('change', applyRl); applyRl();

      // Backpressure custom toggle
      const bpSel = q(root,'#ps-bp'), bpCustom = q(root,'#ps-bp-custom');
      function applyBp(){ show(bpCustom, bpSel.value==='Other'); }
      bpSel.addEventListener('change', applyBp); applyBp();

      // Pools custom toggle (delegate)
      root.addEventListener('change',(e)=>{
        const sel = e.target.closest('.ps-p-comp');
        if(!sel) return;
        const custom = sel.parentElement.querySelector('.ps-p-comp-custom');
        show(custom, sel.value==='Custom');
      });

      // hydrate pools
      const pools = Array.isArray(data.pools)?data.pools:[];
      (pools.length?pools:[{}]).forEach(poolRow);
      // show customs after hydrate
      root.querySelectorAll('.ps-p-comp').forEach(sel=>{
        const custom = sel.parentElement.querySelector('.ps-p-comp-custom');
        show(custom, sel.value==='Custom');
      });
    },
    serialize(target, root){
      function gv(sel){ return (q(root,sel)?.value ?? '').trim(); }

      // targets per env
      target.env = {
        prod:{ rps:gv('.ps-prod-rps'), p95:gv('.ps-prod-p95'), p99:gv('.ps-prod-p99'), err:gv('.ps-prod-err'), slo:gv('.ps-prod-slo') },
        stg :{ rps:gv('.ps-stg-rps'),  p95:gv('.ps-stg-p95'),  p99:gv('.ps-stg-p99'),  err:gv('.ps-stg-err'),  slo:gv('.ps-stg-slo')  },
        dev :{ rps:gv('.ps-dev-rps'),  p95:gv('.ps-dev-p95'),  p99:gv('.ps-dev-p99'),  err:gv('.ps-dev-err'),  slo:gv('.ps-dev-slo')  }
      };

      // resource profile
      target.cpu   = gv('#ps-cpu');
      target.mem   = gv('#ps-mem');
      target.warm  = gv('#ps-warm');

      // autoscaling
      target.minRep    = gv('#ps-minrep');
      target.maxRep    = gv('#ps-maxrep');
      target.hpaMetric = gv('#ps-hpa-metric');
      target.hpaCustom = gv('#ps-hpa-custom');
      target.hpaTarget = gv('#ps-hpa-target');

      // pools
      target.pools = Array.from(root.querySelectorAll('#ps-pools tbody tr')).map(tr=>{
        const compSel = tr.querySelector('.ps-p-comp');
        const comp = compSel ? compSel.value : 'Database';
        const custom = tr.querySelector('.ps-p-comp-custom')?.value || '';
        return {
          comp,
          compCustom: (comp==='Custom') ? custom : '',
          max:  tr.querySelector('.ps-p-max')?.value || '',
          to:   tr.querySelector('.ps-p-to')?.value || '',
          notes:tr.querySelector('.ps-p-notes')?.value || ''
        };
      }).filter(p=> (p.comp==='Custom' ? p.compCustom.trim().length>0 : true));

      // rate limiting
      target.rlPolicy = gv('#ps-rl-policy');
      target.rlPolicyCustom = gv('#ps-rl-policy-custom');
      target.rlLimit  = gv('#ps-rl-limit');
      target.rlScope  = gv('#ps-rl-scope');

      // backpressure
      target.bp     = gv('#ps-bp');
      target.bpCustom = gv('#ps-bp-custom');
      target.bpTh   = gv('#ps-bp-th');
      target.bpFail = gv('#ps-bp-fail');
    }
  });
})();
/* =========================
   STEP 9: Testing Strategy
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function addRow(tb, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tb.appendChild(tr); }
  function show(el,on){ if(el) el.classList.toggle('hidden', !on); }

  registerStep({
    id:'testing_strategy',
    title:'Testing Strategy',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-9');
      root.appendChild(tpl.content.cloneNode(true));

      // toggles
      const apiTool = q(root,'#ts-api-tool'), apiToolCustom = q(root,'#ts-api-tool-custom');
      const perfTool = q(root,'#ts-perf-tool'), perfToolCustom = q(root,'#ts-perf-tool-custom');
      const chaosScen = q(root,'#ts-chaos-scen'), chaosCustom = q(root,'#ts-chaos-custom');
      const anonSel = q(root,'#ts-tdm-anon'), anonCustom = q(root,'#ts-tdm-anon-custom');

      function applyToggles(){
        show(apiToolCustom, apiTool.value==='Other');
        show(perfToolCustom, perfTool.value==='Other');
        show(chaosCustom, chaosScen.value==='Custom');
        show(anonCustom, anonSel.value==='Custom');
      }
      [apiTool,perfTool,chaosScen,anonSel].forEach(el=>el.addEventListener('change', applyToggles));

      // Integration rows
      const intTb = q(root,'#ts-int tbody');
      function toolOptionsFor(comp, val){
        const map = {
          'Database': ['pgTAP','SQLTest','Flyway/Liquibase verify','Custom'],
          'Cache': ['Custom script','k6 (GET/SET)','Integration harness','Custom'],
          'Message broker': ['Testcontainers + consumer','Contract tests','k6 (protocol ext)','Custom'],
          'External service': ['Postman/Newman','Pact (consumer/provider)','WireMock','Custom'],
          'File store': ['Custom harness','S3/GCS emulator','Custom'],
          'Search': ['Integration harness','k6 HTTP','Custom'],
          'Custom': ['Custom']
        };
        const opts = (map[comp]||['Custom']).map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('');
        return `<select class="ts-int-tool">${opts}</select>`;
      }
      function addIntRow(p={}){
        const comp = p.comp || 'Database';
        addRow(intTb, `
          <td>
            <select class="ts-int-comp">
              ${['Database','Cache','Message broker','External service','File store','Search','Custom'].map(o=>`<option ${comp===o?'selected':''}>${o}</option>`).join('')}
            </select>
            <input class="ts-int-comp-custom hidden" type="text" placeholder="Describe custom component" value="${p.compCustom||''}"/>
          </td>
          <td>${toolOptionsFor(comp, p.tool||'')}</td>
          <td><input type="text" class="ts-int-notes" value="${p.notes||''}" placeholder="Config/notes (docker svc, topic, creds secret…)"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      q(root,'#ts-add-int').onclick=()=>addIntRow();

      // Gates rows
      const gTb = q(root,'#ts-gates tbody');
      function addGateRow(p={}){
        addRow(gTb, `
          <td>
            <select class="ts-g-stage">
              ${['PR','Build','Staging','Pre-prod','Prod'].map(o=>`<option ${p.stage===o?'selected':''}>${o}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="ts-g-tests" value="${p.tests||''}" placeholder="Required tests"/></td>
          <td><input type="text" class="ts-g-pass" value="${p.pass||''}" placeholder="Pass criteria"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      q(root,'#ts-add-gate').onclick=()=>addGateRow();

      // Hydrate simple fields
      const map = {
        '#ts-api-coverage':'apiCoverage','#ts-api-versioning':'apiVersioning',
        '#ts-perf-scen':'perfScen','#ts-perf-data':'perfData','#ts-perf-targets':'perfTargets',
        '#ts-perf-env':'perfEnv','#ts-perf-reports':'perfReports',
        '#ts-chaos-blast':'chaosBlast','#ts-chaos-abort':'chaosAbort',
        '#ts-tdm-approach':'tdmApproach','#ts-tdm-cad':'tdmCad'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root, sel); if(el && data[key]!=null) el.value=data[key];
      });

      // selects with customs
      if(data.apiTool) apiTool.value=data.apiTool;
      if(data.apiToolCustom) apiToolCustom.value=data.apiToolCustom;
      if(data.perfTool) perfTool.value=data.perfTool;
      if(data.perfToolCustom) perfToolCustom.value=data.perfToolCustom;
      if(data.chaosScen) chaosScen.value=data.chaosScen;
      if(data.chaosCustom) chaosCustom.value=data.chaosCustom;
      if(data.tdmAnon) anonSel.value=data.tdmAnon;
      if(data.tdmAnonCustom) anonCustom.value=data.tdmAnonCustom;

      // hydrate lists
      const ints = Array.isArray(data.integration)?data.integration:[];
      (ints.length?ints:[{}]).forEach(addIntRow);

      const gates = Array.isArray(data.gates)?data.gates:[];
      (gates.length?gates:[{}]).forEach(addGateRow);

      // apply toggles after hydrate
      applyToggles();

      // delegate for component/tool dynamics
      root.addEventListener('change',(e)=>{
        // component change → update tool list + show custom box
        const compSel = e.target.closest('.ts-int-comp');
        if(compSel){
          const comp = compSel.value;
          const tr = compSel.closest('tr');
          // swap tool cell
          tr.children[1].innerHTML = toolOptionsFor(comp, '');
          // show/hide custom component input
          const custom = tr.querySelector('.ts-int-comp-custom');
          show(custom, comp==='Custom');
        }
      });

      // show custom component inputs on hydrate
      root.querySelectorAll('.ts-int-comp').forEach(sel=>{
        const custom = sel.parentElement.querySelector('.ts-int-comp-custom');
        show(custom, sel.value==='Custom');
      });
    },
    serialize(target, root){
      function v(sel){ return (q(root,sel)?.value ?? '').trim(); }

      // API tests
      target.apiTool = v('#ts-api-tool');
      target.apiToolCustom = v('#ts-api-tool-custom');
      target.apiCoverage = v('#ts-api-coverage');
      target.apiVersioning = v('#ts-api-versioning');

      // Integration by component
      target.integration = Array.from(root.querySelectorAll('#ts-int tbody tr')).map(tr=>{
        const comp = tr.querySelector('.ts-int-comp')?.value || 'Database';
        const compCustom = tr.querySelector('.ts-int-comp-custom')?.value || '';
        const tool = tr.querySelector('.ts-int-tool')?.value || '';
        const notes = tr.querySelector('.ts-int-notes')?.value || '';
        return { comp, compCustom:(comp==='Custom'?compCustom:''), tool, notes };
      }).filter(x => x.tool || (x.comp==='Custom' && x.compCustom.trim().length>0));

      // Performance
      target.perfTool = v('#ts-perf-tool');
      target.perfToolCustom = v('#ts-perf-tool-custom');
      target.perfScen = v('#ts-perf-scen');
      target.perfData = v('#ts-perf-data');
      target.perfTargets = v('#ts-perf-targets');
      target.perfEnv = v('#ts-perf-env');
      target.perfReports = v('#ts-perf-reports');

      // Chaos
      target.chaosScen = v('#ts-chaos-scen');
      target.chaosCustom = v('#ts-chaos-custom');
      target.chaosBlast = v('#ts-chaos-blast');
      target.chaosAbort = v('#ts-chaos-abort');

      // Test data
      target.tdmApproach = v('#ts-tdm-approach');
      target.tdmAnon = v('#ts-tdm-anon');
      target.tdmAnonCustom = v('#ts-tdm-anon-custom');
      target.tdmCad = v('#ts-tdm-cad');

      // CI/CD gates
      target.gates = Array.from(root.querySelectorAll('#ts-gates tbody tr')).map(tr=>({
        stage: tr.querySelector('.ts-g-stage')?.value || 'PR',
        tests: tr.querySelector('.ts-g-tests')?.value || '',
        pass:  tr.querySelector('.ts-g-pass')?.value || ''
      })).filter(g => g.tests.trim().length>0);
    }
  });
})();
/* =========================
   STEP 10: Deployment
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function show(el,on){ if(el) el.classList.toggle('hidden', !on); }

  registerStep({
    id:'deployment',
    title:'Deployment',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-10');
      root.appendChild(tpl.content.cloneNode(true));

      // Toggle helpers
      const ingSel = q(root,'#dp-ing'), ingCustom = q(root,'#dp-ing-custom');
      const cfgSel = q(root,'#dp-cfg'), cfgCustom = q(root,'#dp-cfg-custom');
      function apply(){ show(ingCustom, ingSel.value==='Other'); show(cfgCustom, cfgSel.value==='Other'); }
      ingSel.addEventListener('change', apply);
      cfgSel.addEventListener('change', apply);

      // Hydrate simple fields if present
      const map = {
        '#dp-image':'image','#dp-kind':'kind','#dp-rollout':'rollout',
        '#dp-replicas-min':'repMin','#dp-replicas-max':'repMax','#dp-rolling':'rolling','#dp-canary':'canary',
        '#dp-live':'live','#dp-ready':'ready','#dp-start':'start',
        '#dp-svc-type':'svcType','#dp-ports':'ports','#dp-ing':'ing','#dp-ing-custom':'ingCustom',
        '#dp-cfg':'cfg','#dp-cfg-custom':'cfgCustom','#dp-cm':'cm','#dp-secrets':'secrets',
        '#dp-aff':'aff','#dp-tol':'tol','#dp-pdb':'pdb',
        '#dp-rollback':'rollback','#dp-pipeline':'pipeline','#dp-registry':'registry'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root, sel); if(el && data[key]!=null) el.value=data[key];
      });

      // Tiny summary — read from global state if available
      try{
        const ps = (window.state && state['perf_scalability']) || {};
        const sec = (window.state && state['security']) || {};
        q(root,'#mini-replicas').value = (ps.minRep?`${ps.minRep}`:'') + (ps.maxRep?` → ${ps.maxRep}`:'');
        q(root,'#mini-cpu').value      = ps.cpu || '';
        q(root,'#mini-mem').value      = ps.mem || '';
        q(root,'#mini-hpa').value      = (ps.hpaMetric||'') + (ps.hpaTarget?` = ${ps.hpaTarget}`:'');
        q(root,'#mini-tls').value      = (sec.tls || '—');
        q(root,'#mini-auth').value     = (sec.authMethod || '—');
      }catch(_){/*non-blocking*/}

      // Apply toggles post-hydrate
      apply();
    },
    serialize(target, root){
      function v(sel){ return (q(root,sel)?.value ?? '').trim(); }
      target.image    = v('#dp-image');
      target.kind     = v('#dp-kind');
      target.rollout  = v('#dp-rollout');
      target.repMin   = v('#dp-replicas-min');
      target.repMax   = v('#dp-replicas-max');
      target.rolling  = v('#dp-rolling');
      target.canary   = v('#dp-canary');

      target.live     = v('#dp-live');
      target.ready    = v('#dp-ready');
      target.start    = v('#dp-start');

      target.svcType  = v('#dp-svc-type');
      target.ports    = v('#dp-ports');
      target.ing      = v('#dp-ing');
      target.ingCustom= v('#dp-ing-custom');

      target.cfg      = v('#dp-cfg');
      target.cfgCustom= v('#dp-cfg-custom');
      target.cm       = v('#dp-cm');
      target.secrets  = v('#dp-secrets');

      target.aff      = v('#dp-aff');
      target.tol      = v('#dp-tol');
      target.pdb      = v('#dp-pdb');

      target.rollback = v('#dp-rollback');
      target.pipeline = v('#dp-pipeline');
      target.registry = v('#dp-registry');
    }
  });
})();
/* =========================
   STEP 11: Compliance & Governance
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function addRow(tb, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tb.appendChild(tr); }
  function show(el,on){ if(el) el.classList.toggle('hidden', !on); }

  registerStep({
    id:'compliance_governance',
    title:'Compliance & Governance',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-11');
      root.appendChild(tpl.content.cloneNode(true));

      // toggles for "Other"
      const regs = q(root,'#cg-regs');
      const regsCustom = q(root,'#cg-regs-custom');
      function applyRegs(){
        const vals = Array.from(regs.selectedOptions).map(o=>o.value);
        show(regsCustom, vals.includes('Other'));
      }
      regs.addEventListener('change', applyRegs);

      const secSel = q(root,'#cg-secrets'), secCustom=q(root,'#cg-secrets-custom');
      const audSel = q(root,'#cg-audittrail'), audCustom=q(root,'#cg-audittrail-custom');
      function applyOthers(){
        show(secCustom, secSel.value==='Other');
        show(audCustom, audSel.value==='Other');
      }
      secSel.addEventListener('change', applyOthers);
      audSel.addEventListener('change', applyOthers);

      // tables
      const ctrlTb = q(root,'#cg-controls tbody');
      const excTb  = q(root,'#cg-exc tbody');

      function addCtrlRow(p={}){
        addRow(ctrlTb, `
          <td><input type="text" value="${p.ref||''}" placeholder="e.g., GDPR-32"/></td>
          <td><input type="text" value="${p.impl||''}" placeholder="How enforced"/></td>
          <td><input type="text" value="${p.evidence||''}" placeholder="Evidence location"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function addExcRow(p={}){
        addRow(excTb, `
          <td>
            <select class="cg-ex-type">
              ${['Policy exception','Compensating control','Risk accepted','Other'].map(o=>`<option ${p.type===o?'selected':''}>${o}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="cg-ex-desc" value="${p.desc||''}" placeholder="Describe"/></td>
          <td><input type="text" class="cg-ex-owner" value="${p.owner||''}" placeholder="Owner"/></td>
          <td><input type="text" class="cg-ex-mit" value="${p.mit||''}" placeholder="Mitigation / Expiry"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }

      q(root,'#cg-add-ctrl').onclick=()=>addCtrlRow();
      q(root,'#cg-add-exc').onclick =()=>addExcRow();

      // hydrate simple fields
      const map = {
        '#cg-class':'class','#cg-dpia':'dpia',
        '#cg-residency':'residency','#cg-retention':'retention','#cg-worm':'worm',
        '#cg-rest':'encRest','#cg-transit':'encTransit',
        '#cg-secrets':'secrets','#cg-secrets-custom':'secretsCustom',
        '#cg-access':'accessCad','#cg-audittrail':'auditTrail','#cg-audittrail-custom':'auditTrailCustom',
        '#cg-dsr':'dsr'
      };
      Object.entries(map).forEach(([sel,key])=>{
        const el=q(root, sel); if(el && data[key]!=null) el.value=data[key];
      });

      // hydrate multi-select regs
      if(Array.isArray(data.regs)){
        Array.from(regs.options).forEach(o=>{ o.selected = data.regs.includes(o.value); });
      }
      if(data.regsCustom) regsCustom.value=data.regsCustom;

      // hydrate tables
      const ctls = Array.isArray(data.controls)?data.controls:[];
      (ctls.length?ctls:[{}]).forEach(addCtrlRow);

      const excs = Array.isArray(data.exceptions)?data.exceptions:[];
      (excs.length?excs:[{}]).forEach(addExcRow);

      // apply toggles
      applyRegs(); applyOthers();
    },
    serialize(target, root){
      function v(sel){ return (q(root,sel)?.value ?? '').trim(); }
      function mvals(sel){
        const el=q(root,sel);
        return Array.from(el?.selectedOptions||[]).map(o=>o.value);
      }

      target.regs      = mvals('#cg-regs');
      target.regsCustom= v('#cg-regs-custom');
      target.class     = v('#cg-class');
      target.dpia      = v('#cg-dpia');

      target.residency = v('#cg-residency');
      target.retention = v('#cg-retention');
      target.worm      = v('#cg-worm');

      target.encRest   = v('#cg-rest');
      target.encTransit= v('#cg-transit');
      target.secrets   = v('#cg-secrets');
      target.secretsCustom = v('#cg-secrets-custom');

      target.controls = Array.from(root.querySelectorAll('#cg-controls tbody tr')).map(tr=>({
        ref: tr.children[0].querySelector('input')?.value || '',
        impl: tr.children[1].querySelector('input')?.value || '',
        evidence: tr.children[2].querySelector('input')?.value || ''
      })).filter(r=>r.ref.trim().length>0);

      target.accessCad = v('#cg-access');
      target.auditTrail= v('#cg-audittrail');
      target.auditTrailCustom = v('#cg-audittrail-custom');
      target.dsr       = v('#cg-dsr');

      target.exceptions = Array.from(root.querySelectorAll('#cg-exc tbody tr')).map(tr=>({
        type: tr.querySelector('.cg-ex-type')?.value || 'Policy exception',
        desc: tr.querySelector('.cg-ex-desc')?.value || '',
        owner:tr.querySelector('.cg-ex-owner')?.value || '',
        mit:  tr.querySelector('.cg-ex-mit')?.value || ''
      })).filter(x=>x.desc.trim().length>0);
    }
  });
})();
/* =========================
   STEP 12: Final Chapter — Decisions, Open Questions & Review
========================= */
(function(){
  function q(r,s){return r.querySelector(s);}
  function addRow(tb, html){ const tr=document.createElement('tr'); tr.innerHTML=html; tb.appendChild(tr); }

  registerStep({
    id:'final_chapter',
    title:'Decisions & Review',
    mount(root, data){
      const tpl=document.getElementById('tpl-step-12');
      root.appendChild(tpl.content.cloneNode(true));

      // rows
      const decTb = q(root,'#fc-decisions tbody');
      const qTb   = q(root,'#fc-questions tbody');
      const aTb   = q(root,'#fc-approvals tbody');

      function addDecisionRow(p={}){
        addRow(decTb, `
          <td><textarea class="fc-dec-desc" placeholder="Describe the decision">${p.desc||''}</textarea></td>
          <td><textarea class="fc-dec-rat" placeholder="Rationale / reasoning">${p.rat||''}</textarea></td>
          <td><input type="date" class="fc-dec-date" value="${p.date||''}"/></td>
          <td><input type="text" class="fc-dec-by" value="${p.by||''}" placeholder="Decided by"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function addQuestionRow(p={}){
        addRow(qTb, `
          <td><textarea class="fc-q-q" placeholder="Open question">${p.q||''}</textarea></td>
          <td><input type="text" class="fc-q-to" value="${p.to||''}" placeholder="Directed to"/></td>
          <td><input type="date" class="fc-q-date" value="${p.date||''}"/></td>
          <td>
            <select class="fc-q-pri">
              ${['High','Medium','Low'].map(v=>`<option ${v===p.pri?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>
          <td>
            <select class="fc-q-status">
              ${['New','Asked','Answered','Closed'].map(v=>`<option ${v===p.status?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="fc-q-notes" value="${p.notes||''}" placeholder="Notes"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }
      function addApprovalRow(p={}){
        addRow(aTb, `
          <td>
            <select class="fc-a-role">
              ${['Product Owner','Lead Architect','Security','DevOps','QA Lead','CAB','Other'].map(v=>`<option ${v===p.role?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" class="fc-a-name" value="${p.name||''}" placeholder="Name"/></td>
          <td>
            <select class="fc-a-decision">
              ${['Approve','Approve with comments','Request changes','Reject'].map(v=>`<option ${v===p.decision?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>
          <td><input type="date" class="fc-a-date" value="${p.date||''}"/></td>
          <td><input type="text" class="fc-a-comments" value="${p.comments||''}" placeholder="Comments"/></td>
          <td><button class="btn-mini btn-danger" onclick="this.closest('tr').remove()">✕</button></td>
        `);
      }

      q(root,'#fc-add-decision').onclick=()=>addDecisionRow();
      q(root,'#fc-add-question').onclick=()=>addQuestionRow();
      q(root,'#fc-add-approval').onclick=()=>addApprovalRow();

      // hydrate
      (Array.isArray(data.decisions)?data.decisions:[{}]).forEach(addDecisionRow);
      (Array.isArray(data.questions)?data.questions:[{}]).forEach(addQuestionRow);
      (Array.isArray(data.approvals)?data.approvals:[{}]).forEach(addApprovalRow);

      // Export handler
      q(root,'#fc-export-doc').onclick=()=>{

  // Build a simple HTML document Word understands

  let html = `

    <!DOCTYPE html>

    <html>

    <head><meta charset="utf-8"><title>Final Chapter</title>

      <style>

        body{font-family:Segoe UI,Arial,sans-serif}

        h1,h2{margin:0 0 8px}

        h2{font-size:16px}

        .sec{margin:14px 0}

        table{border-collapse:collapse;width:100%}

        th,td{border:1px solid #ccc;padding:6px;vertical-align:top}

      </style>

    </head>

    <body>

      <h1>FINAL CHAPTER — Decisions, Open Questions & Review</h1>

  `;

  // Decisions

  html += `<div class="sec"><h2>12.1 Decisions</h2><table>

    <thead><tr><th>Decision Description</th><th>Rationale</th><th>Date</th><th>Decided By</th></tr></thead><tbody>`;

  const decTb = root.querySelector('#fc-decisions tbody');

  decTb.querySelectorAll('tr').forEach(tr=>{

    const desc=tr.querySelector('.fc-dec-desc')?.value||'';

    const rat =tr.querySelector('.fc-dec-rat')?.value||'';

    const date=tr.querySelector('.fc-dec-date')?.value||'';

    const by  =tr.querySelector('.fc-dec-by')?.value||'';

    html += `<tr><td>${escapeHtml(desc)}</td><td>${escapeHtml(rat)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(by)}</td></tr>`;

  });

  html += `</tbody></table></div>`;

  // Open Questions

  html += `<div class="sec"><h2>12.2 Open Questions</h2><table>

    <thead><tr><th>Question</th><th>Directed To</th><th>Due Date</th><th>Priority</th><th>Status</th><th>Notes</th></tr></thead><tbody>`;

  const qTb = root.querySelector('#fc-questions tbody');

  qTb.querySelectorAll('tr').forEach(tr=>{

    const q  =tr.querySelector('.fc-q-q')?.value||'';

    const to =tr.querySelector('.fc-q-to')?.value||'';

    const date=tr.querySelector('.fc-q-date')?.value||'';

    const pri =tr.querySelector('.fc-q-pri')?.value||'';

    const st  =tr.querySelector('.fc-q-status')?.value||'';

    const notes=tr.querySelector('.fc-q-notes')?.value||'';

    html += `<tr><td>${escapeHtml(q)}</td><td>${escapeHtml(to)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(pri)}</td><td>${escapeHtml(st)}</td><td>${escapeHtml(notes)}</td></tr>`;

  });

  html += `</tbody></table></div>`;

  // Approvals

  html += `<div class="sec"><h2>12.3 Approvals</h2><table>

    <thead><tr><th>Role</th><th>Name</th><th>Decision</th><th>Date</th><th>Comments</th></tr></thead><tbody>`;

  const aTb = root.querySelector('#fc-approvals tbody');

  aTb.querySelectorAll('tr').forEach(tr=>{

    const role=tr.querySelector('.fc-a-role')?.value||'';

    const name=tr.querySelector('.fc-a-name')?.value||'';

    const dec =tr.querySelector('.fc-a-decision')?.value||'';

    const date=tr.querySelector('.fc-a-date')?.value||'';

    const comm=tr.querySelector('.fc-a-comments')?.value||'';

    html += `<tr><td>${escapeHtml(role)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(dec)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(comm)}</td></tr>`;

  });

  html += `</tbody></table></div>`;

  html += `</body></html>`;

  // Download as .doc (Word HTML)

  const blob = new Blob([html], { type: 'application/msword' });

  const a = document.createElement('a');

  a.href = URL.createObjectURL(blob);

  a.download = 'final_chapter_decisions_review.doc'; // <-- .doc for perfect compatibility

  a.click();

  // helper

  function escapeHtml(s){

    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));

  }

};
    },
    serialize(target, root){
      function val(el){return (el?.value??'').trim();}
      target.decisions = Array.from(root.querySelectorAll('#fc-decisions tbody tr')).map(tr=>({
        desc: val(tr.querySelector('.fc-dec-desc')),
        rat: val(tr.querySelector('.fc-dec-rat')),
        date: val(tr.querySelector('.fc-dec-date')),
        by: val(tr.querySelector('.fc-dec-by'))
      })).filter(x=>x.desc);

      target.questions = Array.from(root.querySelectorAll('#fc-questions tbody tr')).map(tr=>({
        q: val(tr.querySelector('.fc-q-q')),
        to: val(tr.querySelector('.fc-q-to')),
        date: val(tr.querySelector('.fc-q-date')),
        pri: val(tr.querySelector('.fc-q-pri')),
        status: val(tr.querySelector('.fc-q-status')),
        notes: val(tr.querySelector('.fc-q-notes'))
      })).filter(x=>x.q);

      target.approvals = Array.from(root.querySelectorAll('#fc-approvals tbody tr')).map(tr=>({
        role: val(tr.querySelector('.fc-a-role')),
        name: val(tr.querySelector('.fc-a-name')),
        decision: val(tr.querySelector('.fc-a-decision')),
        date: val(tr.querySelector('.fc-a-date')),
        comments: val(tr.querySelector('.fc-a-comments'))
      })).filter(x=>x.role||x.name);
    }
  });
})();
/* ===========================================
   FULL-DOC EXPORT (Word HTML .doc)
=========================================== */
(function(){
  // tiny helpers
  function esc(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  const TRED = '<span style="color:#c00">TBD</span>';
  function hv(v){ const t=String(v??'').trim(); return t?esc(v):TRED; }
  function row(...cells){ return `<tr>${cells.map(c=>`<td>${(String(c??'').trim()?c:TRED)}</td>`).join('')}</tr>`; }
  function head(...cells){ return `<tr>${cells.map(c=>`<th>${c}</th>`).join('')}</tr>`; }
  function tbl(h, rows){
  const body = Array.isArray(rows) ? rows.join('') : String(rows || '');
  return `<table><thead>${h}</thead><tbody>${body}</tbody></table>`;
}
  function sec(title, body){ return `<div class="sec"><h2>${esc(title)}</h2>${body||''}</div>`; }
  function val(obj, key){ return esc((obj && obj[key])||''); }
  function list(label, arr, fmt){
    if(!Array.isArray(arr) || !arr.length) return '';
    const rows = arr.map(x=>row(...fmt(x)));
    return `<h3>${esc(label)}</h3>${tbl('', rows)}`;
  }

  // endpoint table formatters (guard against missing arrays)
  function renderApi(api){
    if(!api) return '';
    const eps = Array.isArray(api.endpoints)? api.endpoints : [];
    const errMaps = Array.isArray(api.errorMap)? api.errorMap : [];
    const epRows = eps.map(e=>{
      return row(
        esc(e.method||''), esc(e.path||''),
        esc(e.idempotent||''), esc(e.safeOpType||''),
        esc((e.idem && e.idem.keySource)||''),
        esc((e.idem && e.idem.duplicateBehavior)||'')
      );
    });
    const errRows = errMaps.map(m=>row(
      esc(m.path||''), esc(m.method||''), esc(m.code||''), esc(m.meaning||'')
    ));
    const epTable = tbl(head('Method','Path','Idempotent','Safe Op','Idem Key Source','Duplicate Behavior'), epRows);
    const errTable = tbl(head('Path','Method','HTTP Code','Meaning'), errRows);
    return `
      <h3>REST Endpoints</h3>${epTable}
      <h3>Error Mapping</h3>${errTable}
      <p><b>Protocol note:</b> REST is the default protocol for all service-to-service and client-to-service communication.</p>
    `;
  }

  function renderBroker(b){
    if(!b) return '';
    const pub = Array.isArray(b.published)? b.published : [];
    const con = Array.isArray(b.consumed)?  b.consumed  : [];
    const pubRows = pub.map(x=>{
      if((x.kind||'').toLowerCase()==='rabbitmq'){
        return row('RabbitMQ', esc(x.event||''), esc(x.exchange||''), esc(x.routingKey||''),
                   esc(x.schemaVersion||''), esc(x.useCase||''), esc(x.delivery||''), esc(x.ordering||''));
      } else {
        return row('Kafka', esc(x.topic||''), esc(x.partitionKey||''), esc(x.partitions||''),
                   esc(x.replication||''), esc(x.schemaVersion||''), esc(x.useCase||''), esc(x.delivery||''), esc(x.ordering||''));
      }
    });
    const conRows = con.map(x=>{
      return row(esc(x.kind||''), esc(x.source||''), esc(x.group||''), esc(x.offset||''), esc(x.delivery||''), esc(x.notes||''));
    });
    const pubHead = head('Kind','Name/Topic','Exchange/Key/PK','Routing/Partitions','Replicas/—','Schema','Use Case','Delivery','Ordering');
    const conHead = head('Kind','Source','Group','Offset','Delivery','Notes');
    return `
      <h3>Rationale</h3>
      <p><b>Internal (K8s):</b> RabbitMQ — lightweight/low latency.<br/>
         <b>External:</b> Kafka — durable, replay.</p>
      <h3>Published Events</h3>${tbl(pubHead, pubRows)}
      <h3>Consumed Events</h3>${tbl(conHead, conRows)}
    `;
  }

  function renderData(d){
    if(!d) return '';
    const pii = Array.isArray(d.piiTable)? d.piiTable : [];
    const idx = Array.isArray(d.indexing)? d.indexing : [];
    const piiRows = pii.map(x=>row(esc(x.field||''), esc(x.access||''), esc(x.restriction||'')));
    const idxRows = idx.map(x=>row(esc(x.strategy||''), esc(x.detail||''), esc(x.rationale||'')));
    return `
      ${tbl(head('DB Type','Rationale','Schema/Document Model'), [row(hv(d.dbType), hv(d.rationale), hv(d.schema))])}
      <h3>PII / Sensitive Data Handling</h3>${tbl(head('What PII','Who can access','How restricted'), piiRows)}
      <h3>Backup & Recovery</h3><p>${hv(d.backupRecovery)}</p>
      <h3>Indexing / Partitioning / Sharding</h3>${tbl(head('Strategy','Details','Rationale'), idxRows)}
      <h3>Retention</h3><p>${hv(d.retention)}</p>
    `;
  }

  function renderCache(c){
    if(!c) return '';
    const layers = Array.isArray(c.layers)? c.layers : [];
    const rows = layers.map(x=>row(esc(x.type||''), esc(x.topology||''), esc(x.ttl||''), esc(x.maxSize||''), esc(x.eviction||''), esc(x.keys||''), esc(x.consistency||'')));
    return tbl(head('Type','Topology','TTL','Max size','Eviction','Key pattern','Consistency'), rows);
  }

  function renderSecurity(s){
    if(!s) return '';
    const scopeTbl = (Array.isArray(s.scopes)? s.scopes : []).map(x=>row(esc(x.scope||''), esc(x.notes||'')));
    const maskTbl  = (Array.isArray(s.masking)? s.masking : []).map(x=>row(esc(x.field||''), esc(x.strategy||'')));
    return `
      ${tbl(head('Auth Method','Token Validation','Token Expiration','Scopes'), [row(hv(s.authMethod), hv(s.tokenValidation), hv(s.tokenExp), hv((s.scopes||[]).map(x=>x.scope).join(', ')) )])}
      <h3>Authorization</h3>
      ${tbl(head('Model','Enforcement Point','Policy'), [row(hv(s.authzModel), hv((s.enforcement||'') + (s.enforcementOther?` (${s.enforcementOther})`:'')), hv(s.policy))])}
      <h3>Security Audit</h3><p>${hv(s.audit)}</p>
      <h3>Data Protection</h3>
      ${tbl(head('PII / Sensitive Data','Who can access','How restricted'), scopeTbl)}
      <h4>Data Masking / Redaction</h4>${tbl(head('Field','Strategy'), maskTbl)}
    `;
  }

  function renderObservability(o){
    if(!o) return '';
    const mets = Array.isArray(o.metrics)? o.metrics : [];
    const dash = Array.isArray(o.dashboards)? o.dashboards : [];
    const alrt = Array.isArray(o.alerts)? o.alerts : [];
    const logs = Array.isArray(o.keyLogs)? o.keyLogs : [];
    return `
      ${tbl(head('Prod level','Staging level','Dev level','Log sink','Tracing','Sampling','Propagation'),
            [row(hv(o.logProd), hv(o.logStg), hv(o.logDev), hv((o.logSink||'') + (o.logSinkCustom?` (${o.logSinkCustom})`:'')), hv((o.tracing||'') + (o.tracingCustom?` (${o.tracingCustom})`:'')), hv(o.sampling), hv(o.propagation))])}
      <h3>Metrics</h3>${tbl(head('Metric','Type','SLO/Target','Collection'), mets.map(m=>row(esc(m.metric||''), esc(m.type||''), esc(m.slo||''), esc(m.collect||''))))}
      <h3>Dashboards</h3>${tbl(head('Name','System','Link/ID'), dash.map(d=>row(esc(d.name||''), esc(d.sys||''), esc(d.link||''))))}
      <h3>Alerts</h3>${tbl(head('Severity','Condition','Channel','Runbook'), alrt.map(a=>row(esc(a.sev||''), esc(a.cond||''), esc(a.chan||''), esc(a.runbook||''))))}
      <h3>Key Log Events</h3>${tbl(head('Type','What we log','Level','PII safe'), logs.map(k=>row(esc(k.type||''), esc(k.what||''), esc(k.level||''), esc(k.pii||''))))}
    `;
  }

  function renderPerf(p){
    if(!p) return '';
    const pools = Array.isArray(p.pools)? p.pools : [];
    const poolsRows = pools.map(x=>row(esc(x.comp==='Custom' ? (x.comp+' — '+(x.compCustom||'')) : x.comp||''), esc(x.max||''), esc(x.to||''), esc(x.notes||'')));
    return `
      <h3>Targets</h3>
      ${tbl(head('Env','RPS','p95 (ms)','p99 (ms)','Error %','Availability %'), [
        row('Production', esc(p.env?.prod?.rps||''), esc(p.env?.prod?.p95||''), esc(p.env?.prod?.p99||''), esc(p.env?.prod?.err||''), esc(p.env?.prod?.slo||'')),
        row('Staging',    esc(p.env?.stg?.rps||''),  esc(p.env?.stg?.p95||''),  esc(p.env?.stg?.p99||''),  esc(p.env?.stg?.err||''),  esc(p.env?.stg?.slo||'')),
        row('Development',esc(p.env?.dev?.rps||''),  esc(p.env?.dev?.p95||''),  esc(p.env?.dev?.p99||''),  esc(p.env?.dev?.err||''),  esc(p.env?.dev?.slo||'')),
      ])}
      <h3>Resources & Autoscaling</h3>
      ${tbl(head('CPU req/limit','Mem req/limit','Startup/Warm','Min→Max replicas','HPA metric','Target'),
            [row(esc(p.cpu||''), esc(p.mem||''), esc(p.warm||''), esc((p.minRep||'')+'→'+(p.maxRep||'')), esc(p.hpaMetric||'' + (p.hpaCustom?` (${esc(p.hpaCustom)})`:'')), esc(p.hpaTarget||''))])}
      <h3>Concurrency & Pools</h3>${tbl(head('Component','Max concurrency','Timeout (ms)','Notes'), poolsRows)}
      <h3>Rate Limiting</h3>${tbl(head('Policy','Limit & window','Scope'), [row(esc(p.rlPolicy||'' + (p.rlPolicyCustom?` (${esc(p.rlPolicyCustom)})`:'')), esc(p.rlLimit||''), esc(p.rlScope||''))])}
      <h3>Backpressure</h3>${tbl(head('Strategy','Thresholds','Fail behavior'), [row(esc(p.bp||'' + (p.bpCustom?` (${esc(p.bpCustom)})`:'')), esc(p.bpTh||''), esc(p.bpFail||''))])}
    `;
  }

  function renderTesting(t){
    if(!t) return '';
    const ints = Array.isArray(t.integration)? t.integration : [];
    const gates = Array.isArray(t.gates)? t.gates : [];
    return `
      ${tbl(head('API Tool','Coverage','Versioning/Broker'), [row(esc(t.apiTool||'' + (t.apiToolCustom?` (${esc(t.apiToolCustom)})`:'')), esc(t.apiCoverage||''), esc(t.apiVersioning||''))])}
      <h3>Integration (by component)</h3>${tbl(head('Component','Tool','Notes'), ints.map(x=>row(esc(x.comp==='Custom' ? (x.comp+' — '+(x.compCustom||'')) : x.comp||''), esc(x.tool||''), esc(x.notes||''))))}
      <h3>Performance</h3>${tbl(head('Tool','Scenario','Dataset','Targets','Env','Reports'),
        [row(esc(t.perfTool||'' + (t.perfToolCustom?` (${esc(t.perfToolCustom)})`:'')), esc(t.perfScen||''), esc(t.perfData||''), esc(t.perfTargets||''), esc(t.perfEnv||''), esc(t.perfReports||''))])}
      <h3>Chaos / Resilience</h3>${tbl(head('Scenario','Blast radius','Abort/Rollback'),
        [row(esc(t.chaosScen||'' + (t.chaosCustom?` (${esc(t.chaosCustom)})`:'')), esc(t.chaosBlast||''), esc(t.chaosAbort||''))])}
      <h3>Test Data</h3>${tbl(head('Approach','Anonymization','Refresh cadence'),
        [row(esc(t.tdmApproach||''), esc(t.tdmAnon||'' + (t.tdmAnonCustom?` (${esc(t.tdmAnonCustom)})`:'')), esc(t.tdmCad||''))])}
      <h3>CI/CD Gates</h3>${tbl(head('Stage','Required tests','Pass criteria'), gates.map(g=>row(esc(g.stage||''), esc(g.tests||''), esc(g.pass||''))))}
    `;
  }

  function renderDeployment(d){
    if(!d) return '';
    return `
      <h3>Workload & Rollout</h3>${tbl(head('Image','Type','Strategy','Min→Max','Rolling params','Canary/BG params'),
        [row(hv(d.image), hv(d.kind), hv(d.rollout), hv((d.repMin||'')+'→'+(d.repMax||'')), hv(d.rolling), hv(d.canary))])}
      <h3>Probes</h3>${tbl(head('Liveness','Readiness','Startup'), [row(esc(d.live||''), esc(d.ready||''), esc(d.start||''))])}
      <h3>Service & Ingress/Gateway</h3>${tbl(head('Service type','Ports','Ingress/Gateway'),
        [row(hv(d.svcType), hv(d.ports), hv((d.ing||'') + (d.ingCustom?` (${d.ingCustom})`:'')))])}
      <h3>Config & Secrets</h3>${tbl(head('Config mgmt','ConfigMaps','Secrets'),
        [row(hv((d.cfg||'') + (d.cfgCustom?` (${d.cfgCustom})`:'')), hv(d.cm), hv(d.secrets))])}
      <h3>Scheduling & Resilience</h3>${tbl(head('Affinity','Tolerations','PDB'), [row(esc(d.aff||''), esc(d.tol||''), esc(d.pdb||''))])}
      <h3>Rollback & CI/CD</h3>${tbl(head('Rollback criteria','Pipeline','Artifact registry'), [row(hv(d.rollback), hv(d.pipeline), hv(d.registry))])}
    `;
  }

  function renderCompliance(c){
    if(!c) return '';
    const regs = (Array.isArray(c.regs)? c.regs : []).join(', ') + (c.regsCustom?` (${c.regsCustom})`: '');
    const ctrls = Array.isArray(c.controls)? c.controls : [];
    const exs   = Array.isArray(c.exceptions)? c.exceptions : [];
    return `
      ${tbl(head('Frameworks','Classification','DPIA'), [row(hv(regs), hv(c.class), hv(c.dpia))])}
      <h3>Residency & Retention</h3>${tbl(head('Region','Retention','WORM/Legal hold'), [row(hv(c.residency), hv(c.retention), hv(c.worm))])}
      <h3>Encryption & Secrets</h3>${tbl(head('At rest','In transit','Secret mgmt'),
        [row(hv(c.encRest), hv(c.encTransit), hv((c.secrets||'') + (c.secretsCustom?` (${c.secretsCustom})`:'')))])}
      <h3>Control Mapping & Evidence</h3>${tbl(head('Control','Implementation','Evidence'), ctrls.map(r=>row(esc(r.ref||''), esc(r.impl||''), esc(r.evidence||''))))}
      <h3>Reviews & Audits</h3>${tbl(head('Access cadence','Audit trail','DSR process'), [row(hv(c.accessCad), hv((c.auditTrail||'') + (c.auditTrailCustom?` (${c.auditTrailCustom})`:'')), hv(c.dsr))])}
      <h3>Exceptions & Risks</h3>${tbl(head('Type','Description','Owner','Mitigation/Expiry'), exs.map(x=>row(esc(x.type||''), esc(x.desc||''), esc(x.owner||''), esc(x.mit||''))))}
    `;
  }

  function renderFinal(f){
    if(!f) return '';
    const decs = Array.isArray(f.decisions)? f.decisions : [];
    const ques = Array.isArray(f.questions)? f.questions : [];
    const appr = Array.isArray(f.approvals)? f.approvals : [];
    return `
      <h3>Decisions</h3>${tbl(head('Description','Rationale','Date','By'), decs.map(x=>row(esc(x.desc||''), esc(x.rat||''), esc(x.date||''), esc(x.by||''))))}
      <h3>Open Questions</h3>${tbl(head('Question','Directed to','Due','Priority','Status','Notes'), ques.map(x=>row(esc(x.q||''), esc(x.to||''), esc(x.date||''), esc(x.pri||''), esc(x.status||''), esc(x.notes||''))))}
      <h3>Approvals</h3>${tbl(head('Role','Name','Decision','Date','Comments'), appr.map(x=>row(esc(x.role||''), esc(x.name||''), esc(x.decision||''), esc(x.date||''), esc(x.comments||''))))}
    `;
  }

  // MAIN export
  window.exportWholeDoc = function(){
    const s = window.state || {};
    let html = `<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>Microservice Detailed Design</title>
      <style>
        body{font-family:Segoe UI,Arial,sans-serif; font-size:12pt}
        h1{font-size:20pt;margin:0 0 10px}
        h2{font-size:14pt;margin:14px 0 6px}
        h3{font-size:12pt;margin:10px 0 6px}
        .sec{margin:12px 0}
        table{border-collapse:collapse;width:100%;margin:6px 0}
        th,td{border:1px solid #ccc;padding:6px;vertical-align:top}
        th{background:#f3f4f6}
        .meta td{border:none;padding:2px 6px}
        a{color:#0066cc;text-decoration:underline}
        a:visited{color:#0066cc}
        .tbd{color:#c00}
      </style>
    </head><body>
      <h1>Microservice Detailed Design</h1>
    `;

    // 1 Service Overview
const so = s.service_overview || {};
const soRows = [
  row('<b>Service name</b>', hv(so.name)),
  row('<b>Owner</b>', hv(so.owner)),
  row('<b>Date</b>', hv(so.date)),
  row('<b>Status</b>', hv(so.status)),
  row('<b>Business context</b>', hv(so.businessContext)),
  row('<b>Service purpose</b>', hv(so.servicePurpose)),
  row('<b>Downstream dependencies</b>', (String((so.downstream||[]).join(', ')).trim()?esc((so.downstream||[]).join(', ')):TRED)),
  row('<b>Upstream consumers</b>',  (String((so.upstream||[]).join(', ')).trim()?esc((so.upstream||[]).join(', ')):TRED))
];
html += sec('1. Service Overview', tbl('', soRows));

    // 2 API
    html += sec('2. API Specifications (REST)', renderApi(s.api_specs));

    // 3 Message Broker
    html += sec('4. Message Broker Integration', renderBroker(s.msg_broker));

    // 4 Data Storage
    html += sec('5. Data Storage', renderData(s.data_storage));

    // 5 Caching Layer
    html += sec('5. Caching Layer', renderCache(s.cache_layer));

    // 6 Security
    html += sec('6/7. Security', renderSecurity(s.security));

    // 7 Observability
    html += sec('6. Observability', renderObservability(s.observability));

    // 8 Performance & Scalability
    html += sec('7. Performance & Scalability', renderPerf(s.perf_scalability));

    // 9 Testing Strategy
    html += sec('9. Testing Strategy', renderTesting(s.testing_strategy));

    // 10 Deployment
    html += sec('10. Deployment', renderDeployment(s.deployment));

    // 11 Compliance & Governance
    html += sec('11. Compliance & Governance', renderCompliance(s.compliance_governance));

    // 12 Final Chapter
    html += sec('12. Decisions, Open Questions & Review', renderFinal(s.final_chapter));

    html += `</body></html>`;

    const blob = new Blob([html], { type: 'application/msword' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'microservice_detailed_design.doc';
    a.click();
  };
  
  // Markdown export (with red TBD via inline HTML span)
  window.exportWholeMarkdown = function(){
    const s = window.state || {};
    const TRED_MD = '<span style="color:red">TBD</span>';
    const mv = v=>{ const t=String(v??'').trim(); return t?String(v):TRED_MD; };
    const mdRow = arr=>`| ${arr.map(c=>c||TRED_MD).join(' | ')} |`;
    const mdTable = (headers, rows)=>{
      const head = `| ${headers.join(' | ')} |`;
      const sep = `| ${headers.map(()=> '---').join(' | ')} |`;
      const body = rows.length? rows.join('\n') : mdRow(headers.map(()=>TRED_MD));
      return `${head}\n${sep}\n${body}`;
    };
    let md = `# Microservice Detailed Design\n`;
    // 1 Service Overview
    const so = s.service_overview || {};
    md += `\n## 1. Service Overview\n`;
    md += mdTable(['Field','Value'], [
      mdRow(['Service name', mv(so.name)]),
      mdRow(['Owner', mv(so.owner)]),
      mdRow(['Date', mv(so.date)]),
      mdRow(['Status', mv(so.status)]),
      mdRow(['Business context', mv(so.businessContext)]),
      mdRow(['Service purpose', mv(so.servicePurpose)])
    ]);
    // 2 API
    const api = s.api_specs || {};
    md += `\n\n## 2. API Specifications (REST)\n`;
    const eps = Array.isArray(api.endpoints)? api.endpoints : [];
    md += mdTable(['Method','Path','Idempotent'], eps.length? eps.map(e=>mdRow([mv(e.method), mv(e.path), mv(e.idempotent)])) : []);
    // 3 Message Broker
    const mb = s.msg_broker || {};
    md += `\n\n## 3. Message Broker Integration\n`;
    const pubs = Array.isArray(mb.published)? mb.published : [];
    md += `\n### Published Events\n`;
    md += mdTable(['Platform','Name/Topic','Routing/PK'], pubs.length? pubs.map(x=> mdRow([mv(x.platform), mv(x.event||x.topic), mv(x.routingKey||x.partitionKey)])) : []);
    const cons = Array.isArray(mb.consumed)? mb.consumed : [];
    md += `\n\n### Consumed Events\n`;
    md += mdTable(['Platform','Source/Topic','Group/Queue'], cons.length? cons.map(x=> mdRow([mv(x.platform), mv(x.topic||x.queue||x.source), mv(x.groupId||'')])) : []);
    // 4 Data Storage
    const ds = s.data_storage || {};
    md += `\n\n## 4. Data Storage\n`;
    md += mdTable(['DB Type','Rationale'], [ mdRow([mv(ds.dbEngine||ds.dbType), mv(ds.dbRationale||ds.rationale)]) ]);
    // 5 Security
    const sec = s.security || {};
    md += `\n\n## 5. Security\n`;
    md += mdTable(['Auth Method','Token Validation'], [ mdRow([mv(sec.authMethod), mv(sec.authValidate)]) ]);
    // 6 Observability
    const ob = s.observability || {};
    md += `\n\n## 6. Observability\n`;
    md += mdTable(['Prod','Staging','Dev'], [ mdRow([mv(ob.logProd), mv(ob.logStg), mv(ob.logDev)]) ]);
    // 7 Performance & Scalability
    const ps = s.perf_scalability || {};
    md += `\n\n## 7. Performance & Scalability\n`;
    md += mdTable(['Env','RPS','p95','p99','Error%','SLO'], [
      mdRow(['Production', mv(ps.env?.prod?.rps), mv(ps.env?.prod?.p95), mv(ps.env?.prod?.p99), mv(ps.env?.prod?.err), mv(ps.env?.prod?.slo)]),
      mdRow(['Staging', mv(ps.env?.stg?.rps), mv(ps.env?.stg?.p95), mv(ps.env?.stg?.p99), mv(ps.env?.stg?.err), mv(ps.env?.stg?.slo)]),
      mdRow(['Development', mv(ps.env?.dev?.rps), mv(ps.env?.dev?.p95), mv(ps.env?.dev?.p99), mv(ps.env?.dev?.err), mv(ps.env?.dev?.slo)])
    ]);
    // 10 Deployment
    const dp = s.deployment || {};
    md += `\n\n## 10. Deployment\n`;
    md += mdTable(['Image','Type','Strategy'], [ mdRow([mv(dp.image), mv(dp.kind), mv(dp.rollout)]) ]);
    // 11 Compliance
    const cg = s.compliance_governance || {};
    md += `\n\n## 11. Compliance & Governance\n`;
    md += mdTable(['Frameworks','Classification'], [ mdRow([mv((cg.regs||[]).join(', ')), mv(cg.class)]) ]);
    // 12 Final
    const fc = s.final_chapter || {};
    md += `\n\n## 12. Decisions, Open Questions & Review\n`;
    const decs = Array.isArray(fc.decisions)? fc.decisions : [];
    md += `\n### Decisions\n` + mdTable(['Decision','Rationale','Date','By'], decs.length? decs.map(x=>mdRow([mv(x.desc), mv(x.rat), mv(x.date), mv(x.by)])) : []);
    const ques = Array.isArray(fc.questions)? fc.questions : [];
    md += `\n\n### Open Questions\n` + mdTable(['Question','To','Due','Pri','Status','Notes'], ques.length? ques.map(x=>mdRow([mv(x.q), mv(x.to), mv(x.date), mv(x.pri), mv(x.status), mv(x.notes)])) : []);
    const appr = Array.isArray(fc.approvals)? fc.approvals : [];
    md += `\n\n### Approvals\n` + mdTable(['Role','Name','Decision','Date','Comments'], appr.length? appr.map(x=>mdRow([mv(x.role), mv(x.name), mv(x.decision), mv(x.date), mv(x.comments)])) : []);

    const blob = new Blob([md], { type: 'text/markdown' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'microservice_detailed_design.md';
    a.click();
  };
})();
/* =========================
   BOOT
========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // preload from localStorage
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(raw){ const obj=JSON.parse(raw); Object.keys(obj).forEach(k=>state[k]=obj[k]); }
  }catch{}
  buildNav();
  go(0);
});

// -------- Mock Data Loader (fills all steps with sample content) --------
function loadMockData(){
  const today = new Date();
  const iso = (d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)(today);
  window.state = window.state || {};

  // 1. Service Overview
  state.service_overview = {
    svcName: 'claims-service',
    svcKey: 'claims-svc',
    svcVer: '1.2.0',
    svcStatus: 'Draft',
    svcDate: iso,
    svcDomain: 'Claims',
    svcOwner: 'Alice Smith',
    svcTL: 'Bob Johnson',
    businessContext: 'Process customer insurance claims from submission to payout.',
    servicePurpose: 'Validate, enrich, persist, and publish claim lifecycle events.',
    externalBoundaries: 'Payments handled by billing-service; policy data by policy-service.',
    responsibilities: [
      { name: 'Validate claim inputs', notes: 'Schema + rules' },
      { name: 'Calculate eligibility', notes: 'Business rules engine' }
    ],
    nonGoals: [ { text: 'Process payments' } ],
    useCases: [
      { name: 'Submit claim', actor: 'Customer', outcome: 'Claim created' },
      { name: 'Approve claim', actor: 'Agent', outcome: 'Claim approved' }
    ]
  };

  // 2. API Specifications
  state.api_specs = {
    swaggerInName: 'claims-api-in.json',
    swaggerOutName: 'claims-api-out.json',
    endpoints: [
      {
        path: '/claims', method: 'POST', idempotent: false,
        idempotency: null, // matches UI logic
        idem: { keySource: '', duplicateBehavior: '' }, // used by exporter
        errors: [ { code:'400', meaning:'Invalid request' }, { code:'500', meaning:'Server error' } ]
      },
      {
        path: '/claims/{id}', method: 'GET', idempotent: true,
        idempotency: null,
        idem: { keySource: '', duplicateBehavior: '' },
        errors: [ { code:'404', meaning:'Not found' } ]
      }
    ]
  };

  // 3. Message Broker
  state.msg_broker = {
    rationale: ['decouple','async','reliability'],
    published: [
      { platform:'RabbitMQ', kind:'RabbitMQ', name:'claim.created', event:'claim.created', exchange:'claims.x', routingKey:'claim.created', schemaVersion:'1.0', useCase:'Notify new claim', delivery:'At-least-once', ordering:'No' }
    ],
    consumed: [
      { platform:'Kafka', kind:'Kafka', name:'policy.updated', topic:'policy.updated', groupId:'claims-svc', reset:'latest', delivery:'At-least-once' }
    ]
  };

  // 4. Data Storage
  state.data_storage = {
    dbEngine:'Postgres', dbCluster:'prod-sql-01', connString:'postgres://user:***@db/claims', dbRationale:'Relational with ACID guarantees',
    schemaSource:'Inline editor', schemaInline:'CREATE TABLE claims(id UUID PRIMARY KEY, status TEXT);', schemaVersion:'1.0.0',
    retention:[ { name:'claims', period:'7y', strategy:'archive', legal:'Yes', notes:'Archive to cold storage' } ],
    struct:{
      indexes:[ { table:'claims', columns:'status', type:'btree', unique:'No' } ],
      partitioning:{ strategy:'none', key:'', notes:'' }
    }
  };

  // 5. Caching Layer
  state.cache_layer = {
    engine:'Redis', usage:'Hot object caching (entities)', topology:'Primary/Replica', size:'5 GB', qps:'3000',
    keyns:'svc:claims:v1:{id}', serialization:'JSON', ttl:'10m', ttlOverrides:'', compress:'Auto (size > N KB)',
    evict:'allkeys-lru', maxmem:'8 GB', persist:'None (pure cache)', replication:'Enabled (replica(s))', hashtag:'{id}',
    invalidate:'Cache-aside (lazy)', warmup:'Top 100 frequent claims', auth:'Password/ACL', tls:'TLS 1.2+', metrics:'cpu, mem, hits/misses'
  };

  // 6. Security
  state.security = {
    authMethod:'OAuth 2.0 (Client Credentials)', authMethodCustom:'', authValidate:'JWKS (signature verify)', authValidateCustom:'', authExp:'1h',
    scopes:[ { scope:'claims:read', desc:'Read claims' }, { scope:'claims:write', desc:'Create/update claims' } ],
    authzModel:'RBAC', authzModelCustom:'', authzEngine:'OPA (Rego)', authzEngineCustom:'', authzEnforce:'API Gateway', authzEnforceCustom:'',
    permissions:[ { role:'Agent', res:'claim', act:'update', cond:'ownsPolicy==true' } ],
    auditScope:'All of the above', auditRet:'1y', auditDst:'Central log pipeline', auditDstCustom:'', auditFields:'subject, scopes, resource, decision, corrId',
    pii:[ { field:'nationalId', who:'Agent', how:'Policy + consent' } ],
    masking:[ { field:'nationalId', kind:'hash', custom:'' } ]
  };

  // 7. Observability
  state.observability = {
    logProd:'INFO', logStg:'DEBUG', logDev:'DEBUG', logSink:'Central log pipeline', logSinkCustom:'',
    tracing:'OpenTelemetry (OTLP)', tracingCustom:'', sampling:'10%', propagation:'W3C traceparent',
    metrics:[ { metric:'p95_latency', type:'histogram', slo:'<300ms', collect:'OTEL SDK' } ],
    dashboards:[ { name:'Claims API', sys:'Grafana', link:'grafana/claims' } ],
    alerts:[ { sev:'High', cond:'error_rate>2%', chan:'Slack', runbook:'Runbook-123' } ],
    keyLogs:[ { type:'API request/response', what:'duration,status,sanitized', level:'INFO', pii:'No' } ]
  };

  // 8. Performance & Scalability
  state.perf_scalability = {
    env:{ prod:{ rps:'1500', p95:'300', p99:'800', err:'0.5', slo:'99.9' }, stg:{ rps:'300', p95:'400', p99:'900', err:'1.0', slo:'99.5' }, dev:{ rps:'50', p95:'500', p99:'1200', err:'2.0', slo:'99.0' } },
    cpu:'300m / 1000m', mem:'512Mi / 1Gi', warm:'20s / 60s',
    minRep:'3', maxRep:'12', hpaMetric:'CPU %', hpaTarget:'70', hpaCustom:'',
    pools:[ { comp:'Database', max:'50', to:'3000', notes:'pg connections' }, { comp:'HTTP outbound', max:'200', to:'2000', notes:'to policy-svc' } ],
    rlPolicy:'Token bucket', rlLimit:'100 req / 1s per user', rlScope:'Per user',
    bp:'Circuit breaker', bpCustom:'', bpTh:'open at 20% errors/30s', bpFail:'Graceful degrade'
  };

  // 9. Testing Strategy
  state.testing_strategy = {
    apiTool:'Postman', apiToolCustom:'', apiCoverage:'Regression', apiVersioning:'Header v1/v2 via gateway',
    integration:[ { comp:'Database', tool:'Flyway/Liquibase verify', notes:'Migrations validated' } ],
    perfTool:'k6', perfToolCustom:'', perfScen:'Spike', perfData:'synthetic 10k claims', perfTargets:'p95<300ms, err<0.5%', perfEnv:'Prod-like staging', perfReports:'S3://perf-reports',
    chaosScen:'Dependency failure (5xx)', chaosCustom:'', chaosBlast:'Single pod', chaosAbort:'error>2% 10m',
    tdmApproach:'Hybrid (seed + synthetic)', tdmAnon:'Mask', tdmAnonCustom:'', tdmCad:'weekly',
    gates:[ { stage:'Staging', tests:'integration + API', pass:'p95<400ms' } ]
  };

  // 10. Deployment
  state.deployment = {
    image:'gcr.io/acme/claims:1.2.3', kind:'Deployment', rollout:'RollingUpdate', repMin:'3', repMax:'12', rolling:'25%/25%', canary:'10%-30%-100%',
    live:'GET /healthz', ready:'GET /ready', start:'GET /startup',
    svcType:'ClusterIP', ports:'HTTP=8080', ing:'Ingress', ingCustom:'',
    cfg:'Helm', cfgCustom:'', cm:'app.yaml, routes.json', secrets:'db-cred, jwt-key',
    aff:'zone=me-west1-b', tol:'dedicated=true:NoSchedule', pdb:'minAvailable=2',
    rollback:'err>2%, p95>800ms for 10m', pipeline:'GitHub Actions', registry:'GCR'
  };

  // 11. Compliance & Governance
  state.compliance_governance = {
    regs:['GDPR','SOC 2'], regsCustom:'', class:'Confidential', dpia:'No',
    residency:'me-west1', retention:'PII 7y, logs 1y', worm:'WORM (bucket-level)',
    encRest:'Provider-managed keys', encTransit:'TLS 1.3', secrets:'Cloud Secret Manager', secretsCustom:'',
    controls:[ { ref:'GDPR-32', impl:'CMEK @ DB + TLS1.3', evidence:'policy + KMS + config' } ],
    accessCad:'Quarterly', auditTrail:'Central log pipeline', auditTrailCustom:'', dsr:'Documented runbook',
    exceptions:[ { type:'Policy exception', desc:'Legacy endpoint no TLS', owner:'Security', mit:'Migrate by Q3' } ]
  };

  // 12. Final Chapter
  state.final_chapter = {
    decisions:[ { desc:'Use Postgres for claims', rat:'ACID needed', date:iso, by:'Architecture Board' } ],
    questions:[ { q:'Support multi-region in phase 1?', to:'Platform', date:iso, pri:'High', status:'Asked', notes:'Cost impact' } ],
    approvals:[ { role:'Lead Architect', name:'Dana', decision:'Approve', date:iso, comments:'LGTM' } ]
  };

  // Re-render current step with new state
  try{ go(active); }catch{ try{ go(0); }catch{} }
  const t = document.getElementById('toast'); if(t){ t.textContent='Loaded mock data'; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  // ... your existing boot code (load state, buildNav, go(0), etc.)
  const ex = document.getElementById('export-doc');
  if(ex) ex.onclick = exportWholeDoc;   // <-- add this line
  const exMd = document.getElementById('export-md');
  if(exMd) exMd.onclick = exportWholeMarkdown;
});

</script>
</body>
</html>